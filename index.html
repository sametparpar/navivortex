<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>NaviVortex V13.28</title>
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.114/Build/Cesium/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.114/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    <style>
        body, html, #cesiumContainer { width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden; background-color: #000; }
        #dashboard {
            position: absolute; top: 20px; left: 20px; width: 260px; 
            background: rgba(15, 23, 42, 0.9); z-index: 100; padding: 20px;
            border-radius: 12px; font-family: sans-serif; color: white; border: 1px solid #38bdf8;
        }
        .btn { width: 100%; padding: 12px; margin-top: 10px; border-radius: 6px; border: none; cursor: pointer; font-weight: bold; text-transform: uppercase; }
        #start-btn { background: #10b981; color: white; display: none; }
        #lock-btn { background: #0ea5e9; color: white; }
        .reset-btn { background: #ef4444; color: white; margin-top: 20px; font-size: 10px; }
    </style>
</head>
<body>
<div id="dashboard">
    <h2 style="margin:0 0 10px 0; color:#38bdf8; font-size: 18px;">NAVIVORTEX V60</h2>
    
    <div style="margin-bottom: 10px; font-size: 13px;">
        <label>Manuel MSL (Denizden):</label>
        <input type="number" id="manual-msl" style="width: 60px; background:#0f172a; color:white; border:1px solid #38bdf8;" 
               onchange="updateManualAlt(this.value)"> m
    </div>

    <div style="margin-top: 15px; font-size: 13px; border-top: 1px solid #334155; padding-top:10px;">
    <label>UÃ§uÅŸ HÄ±zÄ±:</label><br>
    <select id="flight-speed" style="width: 100%; background:#0f172a; color:white; border:1px solid #38bdf8; padding:5px; margin-top:5px;">
        <option value="15">YAVAÅž (54 km/h)</option>
        <option value="40" selected>NORMAL (144 km/h)</option>
        <option value="80">HIZLI (288 km/h)</option>
    </select>
</div>

    <div id="agl-txt" style="color: #10b981; font-weight: bold;">AGL: -- m</div>
    <div id="msl-txt" style="color: #38bdf8; font-size: 0.9em;">MSL: -- m</div>
    
    <button id="lock-btn" class="btn" onclick="toggleLock()">ðŸ”’ LOCK MISSION</button>
    <button id="start-btn" class="btn" onclick="startFlight()">ðŸš€ START FLIGHT</button>
    <button class="btn reset-btn" onclick="location.reload()">RESET SYSTEM</button>
</div>
    <div id="cesiumContainer"></div>

    <script>
        Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiIzMzEyYzc1OS03OTY0LTQ5MGYtODcwMi0zMGNiYmZjNGIxMTkiLCJpZCI6Mzc2MTk2LCJpYXQiOjE3Njc4NjA4NjJ9.aZRZorILCG4gIlzwCnm1L2SCp58z-TCg6yNaDbPLxnU';
        const GOOGLE_API_KEY = 'AIzaSyDDPGFsMFFW8Q8s9Y-2aonzk6LofSBuhps';

        const viewer = new Cesium.Viewer('cesiumContainer', {
            terrain: Cesium.Terrain.fromWorldTerrain(),
            animation: false, timeline: false, baseLayerPicker: false
        });

        viewer.scene.globe.depthTestAgainstTerrain = false;
        viewer.scene.camera.frustum.near = 0.1;

        let drone, waypoints = [], isLocked = false, isFlying = false, heading = 0;
        let dronePos = Cesium.Cartesian3.fromDegrees(28.9784, 41.0082, 100);
        let initialHomePos;

        // 1. Helikopter Model GÃ¼ncellemesi (init fonksiyonu iÃ§inde)
// 2. DÄ°NAMÄ°K BAÅžLANGIÃ‡: KullanÄ±cÄ± Konumuna Git
    if (navigator.geolocation) {
        // TarayÄ±cÄ±dan mevcut koordinatlarÄ± istiyoruz
        navigator.geolocation.getCurrentPosition((position) => {
            const userLon = position.coords.longitude;
            const userLat = position.coords.latitude;
            
            // Helikopteri kullanÄ±cÄ±nÄ±n olduÄŸu yere Ä±ÅŸÄ±nla
            dronePos = Cesium.Cartesian3.fromDegrees(userLon, userLat, 150);
            
            // KamerayÄ± kullanÄ±cÄ±nÄ±n Ã¼zerine odakla
            viewer.camera.flyTo({
                destination: Cesium.Cartesian3.fromDegrees(userLon, userLat, 1000),
                duration: 3 // 3 saniyede sÃ¼zÃ¼lerek git
            });
        }, (error) => {
            // KullanÄ±cÄ± izin vermezse veya hata olursa varsayÄ±lan noktada (Ä°negÃ¶l) baÅŸla
            console.warn("Konum izni alÄ±namadÄ±, varsayÄ±lan konum kullanÄ±lÄ±yor.");
            fallbackToDefaultLocation();
        });
    } else {
        // TarayÄ±cÄ± bu Ã¶zelliÄŸi desteklemiyorsa varsayÄ±lan noktada baÅŸla
        fallbackToDefaultLocation();
    }

    // YardÄ±mcÄ± Fonksiyon: Konum bulunamazsa Bursa'da baÅŸlasÄ±n
    function fallbackToDefaultLocation() {
        dronePos = Cesium.Cartesian3.fromDegrees(29.51, 40.08, 150);
        viewer.camera.setView({ 
            destination: Cesium.Cartesian3.fromDegrees(29.51, 40.08, 1000) 
        });
    }

    // Helikopterimizi ekliyoruz (GÃ¶rÃ¼nÃ¼rlÃ¼k iÃ§in Ã¶lÃ§eÄŸi artÄ±rÄ±ldÄ±)
drone = viewer.entities.add({
    name: "Helicopter",
    position: new Cesium.CallbackProperty(() => dronePos, false),
orientation: new Cesium.CallbackProperty(() => {
    // Helikopter modelleri genelde 90 derece sapma ile gelir
    // heading aÃ§Ä±sÄ±na -90 ekleyerek burnu ileri sabitliyoruz
    return Cesium.Transforms.headingPitchRollQuaternion(
        dronePos, 
        new Cesium.HeadingPitchRoll(Cesium.Math.toRadians(heading - 90), 0, 0)
    );
}, false),
    model: { 
        uri: 'https://raw.githubusercontent.com/CesiumGS/cesium/main/Apps/SampleData/models/CesiumAir/Cesium_Air.glb', 
        minimumPixelSize: 100,
        scale: 1.5,
        disableDepthTestDistance: Number.POSITIVE_INFINITY 
    }
});

    viewer.camera.flyTo({ destination: Cesium.Cartesian3.fromDegrees(28.9784, 41.0082, 1000) });

    // 2. TÄ±klama ile Rota ve Heliport Belirleme
    const handler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);
    handler.setInputAction((click) => {
        if (isLocked || isFlying) return;
        
        const picked = viewer.scene.pickPosition(click.position);
        if (Cesium.defined(picked)) {
            const carto = Cesium.Cartographic.fromCartesian(picked);
            const droneAlt = Cesium.Cartographic.fromCartesian(dronePos).height;
            
            const fixedPos = Cesium.Cartesian3.fromDegrees(
                Cesium.Math.toDegrees(carto.longitude), 
                Cesium.Math.toDegrees(carto.latitude), 
                droneAlt
            );

            if (waypoints.length === 0) initialHomePos = dronePos;

            // Nokta tipini belirle (KalkÄ±ÅŸ, Yol, Ä°niÅŸ)
            let pointColor = Cesium.Color.YELLOW;
            let labelText = "WAYPOINT";
            if (waypoints.length === 0) { pointColor = Cesium.Color.DEEPSKYBLUE; labelText = "START HELIPORT"; }

            const wp = {
                pos: fixedPos,
                entity: viewer.entities.add({
                    position: new Cesium.CallbackProperty(() => wp.pos, false),
                    point: { pixelSize: 12, color: pointColor, outlineColor: Cesium.Color.WHITE, outlineWidth: 2, disableDepthTestDistance: Number.POSITIVE_INFINITY },
                    label: { text: labelText, font: '12px sans-serif', verticalOrigin: Cesium.VerticalOrigin.BOTTOM, pixelOffset: new Cesium.Cartesian2(0, -15), disableDepthTestDistance: Number.POSITIVE_INFINITY }
                }),
                anchor: viewer.entities.add({
                    polyline: {
                        positions: new Cesium.CallbackProperty(() => {
                            const c = Cesium.Cartographic.fromCartesian(wp.pos);
                            const terrainHeight = viewer.scene.sampleHeight(c) || 0;
                            return [Cesium.Cartesian3.fromRadians(c.longitude, c.latitude, terrainHeight), wp.pos];
                        }, false),
                        width: 1,
                        material: new Cesium.PolylineDashMaterialProperty({ color: Cesium.Color.WHITE.withAlpha(0.5) }),
                        disableDepthTestDistance: Number.POSITIVE_INFINITY 
                    }
                }),
                line: viewer.entities.add({
                    polyline: {
                        positions: new Cesium.CallbackProperty(() => {
                            let idx = waypoints.indexOf(wp);
                            let start = (idx === 0) ? initialHomePos : waypoints[idx-1].pos;
                            return [start, wp.pos];
                        }, false),
                        width: 8,
                        material: Cesium.Color.fromCssColorString('#0ea5e9').withAlpha(0.6), // HavacÄ±lÄ±k koridoru mavisi
                        disableDepthTestDistance: Number.POSITIVE_INFINITY,
                        arcType: Cesium.ArcType.NONE
                    }
                })
            };
            waypoints.push(wp);
            
            // Son noktayÄ± her zaman "DESTINATION HELIPORT" olarak gÃ¼ncelle
            if (waypoints.length > 1) {
                waypoints[waypoints.length-1].entity.label.text = "DESTINATION HELIPORT";
                waypoints[waypoints.length-1].entity.point.color = Cesium.Color.RED;
                if (waypoints.length > 2) {
                    waypoints[waypoints.length-2].entity.label.text = "CORRIDOR POINT";
                    waypoints[waypoints.length-2].entity.point.color = Cesium.Color.YELLOW;
                }
            }
        }
    }, Cesium.ScreenSpaceEventType.LEFT_CLICK);





viewer.geocoder.viewModel.destinationFound = function(destination) {
    const cartographic = Cesium.Cartographic.fromCartesian(destination);
    const lon = Cesium.Math.toDegrees(cartographic.longitude);
    const lat = Cesium.Math.toDegrees(cartographic.latitude);
    
    setTimeout(() => {
        const ground = viewer.scene.sampleHeight(cartographic) || 0;
        dronePos = Cesium.Cartesian3.fromDegrees(lon, lat, ground + 100);
        viewer.camera.flyTo({ 
            destination: Cesium.Cartesian3.fromDegrees(lon, lat, ground + 500),
            duration: 2
        });
    }, 1500);
    return destination;
};

// BaÅŸlangÄ±Ã§ Konumunu Ä°negÃ¶l/Bursa Yap
dronePos = Cesium.Cartesian3.fromDegrees(29.5100, 40.0800, 150); 
viewer.camera.setView({ 
    destination: Cesium.Cartesian3.fromDegrees(29.5100, 40.0800, 800) 
});



    

document.addEventListener('keydown', (e) => {
    if (isLocked || isFlying) return;
    const k = e.key.toLowerCase();
    
    // Mevcut konumu al
    const c = Cesium.Cartographic.fromCartesian(dronePos);
    let lon = Cesium.Math.toDegrees(c.longitude);
    let lat = Cesium.Math.toDegrees(c.latitude);
    let alt = c.height;
    
    // Helikopter hÄ±zÄ± (HavacÄ±lÄ±k iÃ§in biraz daha artÄ±rÄ±ldÄ±)
    const moveStep = 0.0001; 

    // YÃ¶n Hesaplama (W artÄ±k baktÄ±ÄŸÄ±n yÃ¶ne gider)
    // Helikopterin heading aÃ§Ä±sÄ±nÄ± radyana Ã§evirip trigonometrik ilerleme yapÄ±yoruz
    const rad = Cesium.Math.toRadians(heading);
// W ve S tuÅŸlarÄ±nÄ±n yÃ¶nÃ¼nÃ¼ 180 derece Ã§evirdik (Ä°leri gitmesi iÃ§in)
if (k === 'w') { 
    lat += moveStep * Math.cos(rad); 
    lon += moveStep * Math.sin(rad); 
}
if (k === 's') { 
    lat -= moveStep * Math.cos(rad); 
    lon -= moveStep * Math.sin(rad); 
}
// A ve D tuÅŸlarÄ± dÃ¶nÃ¼ÅŸ yÃ¶nÃ¼nÃ¼ daha doÄŸal hissettirmek iÃ§in hassaslaÅŸtÄ±rÄ±ldÄ±
if (k === 'a') heading -= 2; 
if (k === 'd') heading += 2;
    
    // YÃ¼kseklik (Q/E)
    if (k === 'q') alt += 1;
    if (k === 'e') alt -= 1;

    // Pozisyonu GÃ¼ncelle
    dronePos = Cesium.Cartesian3.fromDegrees(lon, lat, alt);

    // AGL HESAPLAMA (KRÄ°TÄ°K DÃœZELTME)
    // sampleHeight helikopterin kendisine Ã§arpmasÄ±n diye drone objesini hariÃ§ tutuyoruz
    const groundHeight = viewer.scene.sampleHeight(c, [drone]) || 0;
    const currentAGL = alt - groundHeight;

    // Dashboard GÃ¼ncelleme
    document.getElementById('agl-txt').innerText = "AGL: " + Math.round(currentAGL) + " m (Yerden)";
    document.getElementById('msl-txt').innerText = "MSL: " + Math.round(alt) + " m (Denizden)";
});

        function toggleLock() {
            if (waypoints.length === 0) return;
            isLocked = !isLocked;
            document.getElementById('start-btn').style.display = isLocked ? "block" : "none";
            document.getElementById('lock-btn').innerText = isLocked ? "ðŸ”“ UNLOCK" : "ðŸ”’ LOCK MISSION";
        }

        async function startFlight() {
            isFlying = true;
            viewer.trackedEntity = drone;
            let currentPos = dronePos;
            for (const wp of waypoints) {
                const start = currentPos;
                const end = wp.pos;
                const speed = parseFloat(document.getElementById('flight-speed').value);
                const duration = Cesium.Cartesian3.distance(start, end) / speed;
                await new Promise(resolve => {
                    let startTime = performance.now();
function frame(now) {
    let t = Math.min((now - startTime) / (duration * 1000), 1);
    
    // YÃ–NÃœ HESAPLA: Mevcut pozisyon ile hedef arasÄ±ndaki aÃ§Ä±yÄ± bul
    const direction = Cesium.Cartesian3.subtract(end, start, new Cesium.Cartesian3());
    const cartoStart = Cesium.Cartographic.fromCartesian(start);
    const cartoEnd = Cesium.Cartographic.fromCartesian(end);
    
    // Ä°ki nokta arasÄ±ndaki aÃ§Ä±yÄ± (bearing) hesapla
    const y = Math.sin(cartoEnd.longitude - cartoStart.longitude) * Math.cos(cartoEnd.latitude);
    const x = Math.cos(cartoStart.latitude) * Math.sin(cartoEnd.latitude) -
              Math.sin(cartoStart.latitude) * Math.cos(cartoEnd.latitude) * Math.cos(cartoEnd.longitude - cartoStart.longitude);
    
    // Global heading deÄŸiÅŸkenini gÃ¼ncelle (RadyanÄ± dereceye Ã§evir)
    heading = Cesium.Math.toDegrees(Math.atan2(y, x));

    dronePos = Cesium.Cartesian3.lerp(start, end, t, new Cesium.Cartesian3());
    if (t < 1) requestAnimationFrame(frame); else resolve();
}
                    requestAnimationFrame(frame);
                });
                currentPos = end;
            }
            isFlying = false;
            viewer.trackedEntity = undefined;
        }







        async function goToLocation() {
    const query = document.getElementById('search-city').value.trim();
    if (!query) return;

    // 1. Senaryo: Koordinat giriÅŸi (Ã–rn: 40.1, 29.5)
    if (query.includes(',')) {
        const coords = query.split(',');
        const lat = parseFloat(coords[0]);
        const lon = parseFloat(coords[1]);
        if (!isNaN(lat) && !isNaN(lon)) {
            teleportHelicopter(lat, lon);
            return;
        }
    }

    // 2. Senaryo: Yer ismi giriÅŸi (Ã–rn: "Bursa", "AnÄ±tkabir")
    try {
        const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`);
        const data = await response.json();

        if (data && data.length > 0) {
            const lat = parseFloat(data[0].lat);
            const lon = parseFloat(data[0].lon);
            teleportHelicopter(lat, lon);
        } else {
            alert("Yer bulunamadÄ±. LÃ¼tfen daha spesifik bir isim yazÄ±n.");
        }
    } catch (error) {
        console.error("Arama hatasÄ±:", error);
        alert("Arama servisine ÅŸu an ulaÅŸÄ±lamÄ±yor.");
    }
}

// Helikopteri ve kamerayÄ± taÅŸÄ±yan yardÄ±mcÄ± fonksiyon
function teleportHelicopter(lat, lon) {
    // Helikopteri oraya taÅŸÄ±
    dronePos = Cesium.Cartesian3.fromDegrees(lon, lat, 100);
    
    // KamerayÄ± oraya uÃ§ur
    viewer.camera.flyTo({
        destination: Cesium.Cartesian3.fromDegrees(lon, lat, 1000),
        duration: 2
    });
}





        



        
        
                init();




// MANUEL YÃœKSEKLÄ°K GÄ°RÄ°ÅžÄ° FONKSÄ°YONU
function updateManualAlt(val) {
    if(!val) return;
    const c = Cesium.Cartographic.fromCartesian(dronePos);
    const lon = Cesium.Math.toDegrees(c.longitude);
    const lat = Cesium.Math.toDegrees(c.latitude);
    // Drone'u kullanÄ±cÄ±nÄ±n girdiÄŸi yeni MSL yÃ¼ksekliÄŸine taÅŸÄ±r
    dronePos = Cesium.Cartesian3.fromDegrees(lon, lat, parseFloat(val));
}






        
    </script>
</body>
</html>












