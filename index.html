<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>NaviVortex V09.08</title>
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.114/Build/Cesium/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.114/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    <style>
        body, html, #cesiumContainer { width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden; background-color: #000; }
        #dashboard {
            position: absolute; top: 20px; left: 20px; width: 260px; 
            background: rgba(15, 23, 42, 0.9); z-index: 100; padding: 20px;
            border-radius: 12px; font-family: sans-serif; color: white; border: 1px solid #38bdf8;
        }
        .btn { width: 100%; padding: 12px; margin-top: 10px; border-radius: 6px; border: none; cursor: pointer; font-weight: bold; text-transform: uppercase; }
        #start-btn { background: #10b981; color: white; display: none; }
        #lock-btn { background: #0ea5e9; color: white; }
        .reset-btn { background: #ef4444; color: white; margin-top: 20px; font-size: 10px; }
    </style>
</head>
<body>
    <div id="dashboard">
        <h2 style="margin:0 0 10px 0; color:#38bdf8;">NAVIVORTEX V52</h2>
        <div id="alt-txt">Altitude: 100 m</div>
        <button id="lock-btn" class="btn" onclick="toggleLock()">ðŸ”’ LOCK MISSION</button>
        <button id="start-btn" class="btn" onclick="startFlight()">ðŸš€ START FLIGHT</button>
        <button class="btn reset-btn" onclick="location.reload()">RESET SYSTEM</button>
    </div>
    <div id="cesiumContainer"></div>

    <script>
        Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiIzMzEyYzc1OS03OTY0LTQ5MGYtODcwMi0zMGNiYmZjNGIxMTkiLCJpZCI6Mzc2MTk2LCJpYXQiOjE3Njc4NjA4NjJ9.aZRZorILCG4gIlzwCnm1L2SCp58z-TCg6yNaDbPLxnU';
        const GOOGLE_API_KEY = 'AIzaSyDDPGFsMFFW8Q8s9Y-2aonzk6LofSBuhps';

        const viewer = new Cesium.Viewer('cesiumContainer', {
            terrain: Cesium.Terrain.fromWorldTerrain(),
            animation: false, timeline: false, baseLayerPicker: false
        });

        // GÃ–RSEL STABÄ°LÄ°TE AYARLARI
        viewer.scene.globe.depthTestAgainstTerrain = false;
        viewer.scene.camera.frustum.near = 0.1;
        viewer.scene.logarithmicDepthBuffer = true;

        let drone, waypoints = [], isLocked = false, isFlying = false, heading = 0;
        let dronePos = Cesium.Cartesian3.fromDegrees(28.9784, 41.0082, 100);
        let initialHomePos;

        async function init() {
            const tileset = await Cesium.createGooglePhotorealistic3DTileset(GOOGLE_API_KEY);
            viewer.scene.primitives.add(tileset);

            drone = viewer.entities.add({
                position: new Cesium.CallbackProperty(() => dronePos, false),
                orientation: new Cesium.CallbackProperty(() => {
                    return Cesium.Transforms.headingPitchRollQuaternion(dronePos, new Cesium.HeadingPitchRoll(Cesium.Math.toRadians(heading), 0, 0));
                }, false),
                model: { 
                    uri: 'https://raw.githubusercontent.com/CesiumGS/cesium/main/Apps/SampleData/models/CesiumDrone/CesiumDrone.glb', 
                    minimumPixelSize: 80,
                    disableDepthTestDistance: Number.POSITIVE_INFINITY 
                }
            });

            viewer.camera.flyTo({ destination: Cesium.Cartesian3.fromDegrees(28.9784, 41.0082, 400) });

            const handler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);
            handler.setInputAction((click) => {
                if (isLocked || isFlying) return;
                
                const picked = viewer.scene.pickPosition(click.position);
if (Cesium.defined(picked)) {
    // 1. TÄ±klanan yerin koordinatlarÄ±nÄ± al
    const carto = Cesium.Cartographic.fromCartesian(picked);
    
    // 2. Drone'un o anki yÃ¼ksekliÄŸini al
    const currentDroneAlt = Cesium.Cartographic.fromCartesian(dronePos).height;
    
    // 3. TÄ±klanan noktanÄ±n yÃ¼ksekliÄŸini drone'un yÃ¼ksekliÄŸine zorla sabitle
    const fixedPos = Cesium.Cartesian3.fromRadians(carto.longitude, carto.latitude, currentDroneAlt);

    if (waypoints.length === 0) initialHomePos = dronePos;

    const wp = {
        pos: fixedPos, // ArtÄ±k picked deÄŸil, yÃ¼ksekliÄŸi sabitlenmiÅŸ fixedPos kullanÄ±yoruz
        entity: viewer.entities.add({
            position: new Cesium.CallbackProperty(() => wp.pos, false),
            point: { 
                pixelSize: 10, 
                color: Cesium.Color.YELLOW,
                disableDepthTestDistance: Number.POSITIVE_INFINITY 
            }
        }),
        anchor: viewer.entities.add({
            polyline: {
                positions: new Cesium.CallbackProperty(() => {
                    const c = Cesium.Cartographic.fromCartesian(wp.pos);
                    const ground = Cesium.Cartesian3.fromRadians(c.longitude, c.latitude, 0);
                    return [ground, wp.pos];
                }, false),
                width: 2,
                material: new Cesium.PolylineDashMaterialProperty({ color: Cesium.Color.WHITE.withAlpha(0.6) }),
                disableDepthTestDistance: Number.POSITIVE_INFINITY
            }
        }),
        line: viewer.entities.add({
            polyline: {
                positions: new Cesium.CallbackProperty(() => {
                    let idx = waypoints.indexOf(wp);
                    let start = (idx === 0) ? initialHomePos : waypoints[idx-1].pos;
                    return [start, wp.pos];
                }, false),
                width: 6,
                material: Cesium.Color.GREEN,
                depthFailMaterial: Cesium.Color.GREEN,
                disableDepthTestDistance: Number.POSITIVE_INFINITY,
                arcType: Cesium.ArcType.NONE
            }
        })
    };
    waypoints.push(wp);
}
                        // DÄ°KEY Ä°ZDÃœÅžÃœM HATTI (BEYAZ KESÄ°K)
                        anchor: viewer.entities.add({
                            polyline: {
                                positions: new Cesium.CallbackProperty(() => {
                                    const carto = Cesium.Cartographic.fromCartesian(wp.pos);
                                    const ground = Cesium.Cartesian3.fromRadians(carto.longitude, carto.latitude, 0);
                                    return [ground, wp.pos];
                                }, false),
                                width: 2,
                                material: new Cesium.PolylineDashMaterialProperty({ color: Cesium.Color.WHITE.withAlpha(0.6) }),
                                disableDepthTestDistance: Number.POSITIVE_INFINITY
                            }
                        }),
                        // ANA YEÅžÄ°L ROTA HATTI
                        line: viewer.entities.add({
                            polyline: {
                                positions: new Cesium.CallbackProperty(() => {
                                    let idx = waypoints.indexOf(wp);
                                    let start = (idx === 0) ? initialHomePos : waypoints[idx-1].pos;
                                    return [start, wp.pos];
                                }, false),
                                width: 6,
                                material: Cesium.Color.GREEN,
                                depthFailMaterial: Cesium.Color.GREEN, // BinalarÄ±n arkasÄ±nda kalsa bile yeÅŸil Ã§iz
                                disableDepthTestDistance: Number.POSITIVE_INFINITY,
                                arcType: Cesium.ArcType.NONE
                            }
                        })
                    };
                    waypoints.push(wp);
                }
            }, Cesium.ScreenSpaceEventType.LEFT_CLICK);
        }

        // KLAVYE KONTROLLERÄ°
        document.addEventListener('keydown', (e) => {
            if (isLocked || isFlying) return;
            const c = Cesium.Cartographic.fromCartesian(dronePos);
            let lon = Cesium.Math.toDegrees(c.longitude), lat = Cesium.Math.toDegrees(c.latitude), alt = c.height;
            const s = 0.00005, k = e.key.toLowerCase();
            
            if (k === 'a') heading -= 5;
            if (k === 'd') heading += 5;
            if (k === 'w') { lat += s * Math.cos(Cesium.Math.toRadians(heading)); lon += s * Math.sin(Cesium.Math.toRadians(heading)); }
            if (k === 's') { lat -= s * Math.cos(Cesium.Math.toRadians(heading)); lon -= s * Math.sin(Cesium.Math.toRadians(heading)); }
            if (k === 'q') alt += 2;
            if (k === 'e') alt = Math.max(0.1, alt - 2);
            
            dronePos = Cesium.Cartesian3.fromDegrees(lon, lat, alt);
            document.getElementById('alt-txt').innerText = "Altitude: " + Math.round(alt) + " m";
        });

        function toggleLock() {
            if (waypoints.length === 0) return;
            isLocked = !isLocked;
            document.getElementById('start-btn').style.display = isLocked ? "block" : "none";
            document.getElementById('lock-btn').innerText = isLocked ? "ðŸ”“ UNLOCK" : "ðŸ”’ LOCK MISSION";
        }

        async function startFlight() {
            isFlying = true;
            viewer.trackedEntity = drone;

            let currentPos = dronePos;
            for (const wp of waypoints) {
                const start = currentPos;
                const end = wp.pos;
                const duration = Cesium.Cartesian3.distance(start, end) / 20;

                await new Promise(resolve => {
                    let startTime = performance.now();
                    function frame(now) {
                        let t = Math.min((now - startTime) / (duration * 1000), 1);
                        dronePos = Cesium.Cartesian3.lerp(start, end, t, new Cesium.Cartesian3());
                        const dir = Cesium.Cartesian3.normalize(Cesium.Cartesian3.subtract(end, start, new Cesium.Cartesian3()), new Cesium.Cartesian3());
                        heading = Cesium.Math.toDegrees(Math.atan2(dir.x, dir.y));
                        if (t < 1) requestAnimationFrame(frame); else resolve();
                    }
                    requestAnimationFrame(frame);
                });
                currentPos = end;
            }
            isFlying = false;
            viewer.trackedEntity = undefined;
        }

        init();
    </script>
</body>
</html>

