<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>NaviVortex V17.07</title>
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.114/Build/Cesium/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.114/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    <style>
        body, html, #cesiumContainer { width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden; background-color: #000; }
        #dashboard {
            position: absolute; top: 20px; left: 20px; width: 260px; 
            background: rgba(15, 23, 42, 0.9); z-index: 100; padding: 20px;
            border-radius: 12px; font-family: sans-serif; color: white; border: 1px solid #38bdf8;
        }
        .btn { width: 100%; padding: 12px; margin-top: 10px; border-radius: 6px; border: none; cursor: pointer; font-weight: bold; text-transform: uppercase; }
        #start-btn { background: #10b981; color: white; display: none; }
        #lock-btn { background: #0ea5e9; color: white; }
        .reset-btn { background: #ef4444; color: white; margin-top: 20px; font-size: 10px; }
    </style>


     <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
</head>
<body>
<div id="dashboard">

<div id="auth-section" style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #334155;">
    <div id="logged-out-view">
        <button class="btn" style="background: #4285F4; color: white; margin-bottom: 10px;" onclick="loginWithGoogle()">Sign in with Google</button>
        <div style="text-align: center; margin: 5px 0; font-size: 10px; color: #94a3b8;">â€” OR â€”</div>
        <input type="email" id="auth-email" placeholder="Email Address" style="margin-bottom: 5px; width: 100%; padding: 8px; background: #1e293b; border: 1px solid #334155; color: white;">
        <input type="password" id="auth-password" placeholder="Password" style="margin-bottom: 5px; width: 100%; padding: 8px; background: #1e293b; border: 1px solid #334155; color: white;">
        <div style="display: flex; gap: 5px;">
            <button class="btn" style="background: #334155; flex: 1;" onclick="handleEmailAuth('login')">Login</button>
            <button class="btn" style="background: #0ea5e9; flex: 1;" onclick="handleEmailAuth('signup')">Sign Up</button>
        </div>
    </div>
    <div id="user-info" style="display: none; justify-content: space-between; align-items: center;">
        <span id="user-name" style="color: #38bdf8; font-weight: bold; font-size: 13px;"></span>
        <button onclick="logout()" style="background:none; border:none; color:#ef4444; cursor:pointer; text-decoration:underline; font-size: 11px;">Logout</button>
    </div>
</div>

<div id="save-section" style="display: none; border-top: 1px solid #334155; margin-top: 10px; padding-top: 10px;">
    <input type="text" id="route-name" placeholder="Mission Name (e.g. Alpha 1)" style="margin-bottom: 5px; width: 100%; padding: 8px; background: #1e293b; border: 1px solid #334155; color: white;">
    <button class="btn" style="background: #10b981; margin-bottom: 10px;" onclick="saveRoute()">ðŸ’¾ SAVE MISSION</button>
    
    <label style="font-size: 11px; color: #94a3b8; display: block; margin-top: 10px;">STORED MISSIONS</label>
    <div id="mission-list" style="margin-top: 5px; max-height: 150px; overflow-y: auto;">
        </div>
</div>



    
    <h2 style="margin:0 0 10px 0; color:#38bdf8; font-size: 18px;">NAVIVORTEX V60</h2>
    
    <div style="margin-bottom: 10px; font-size: 13px;">
        <label>Manuel MSL (Altitude):</label>
        <input type="number" id="manual-msl" style="width: 60px; background:#0f172a; color:white; border:1px solid #38bdf8;" 
               onchange="updateManualAlt(this.value)"> m
    </div>

    <div style="margin-top: 15px; font-size: 13px; border-top: 1px solid #334155; padding-top:10px;">
    <label>Cruise Speed:</label><br>
    <select id="flight-speed" style="width: 100%; background:#0f172a; color:white; border:1px solid #38bdf8; padding:5px; margin-top:5px;">
        <option value="15">Slow (54 km/h)</option>
        <option value="40" selected>Normal (144 km/h)</option>
        <option value="80">Speed (288 km/h)</option>
    </select>
</div>

    <div id="agl-txt" style="color: #10b981; font-weight: bold;">AGL: -- m</div>
    <div id="msl-txt" style="color: #38bdf8; font-size: 0.9em;">MSL: -- m</div>
    
    <button id="lock-btn" class="btn" onclick="toggleLock()">ðŸ”’ LOCK MISSION</button>
    <button id="start-btn" class="btn" onclick="startFlight()">ðŸš€ START FLIGHT</button>
    <button class="btn reset-btn" onclick="resetSystem()">RESET SYSTEM</button>
</div>
    <div id="cesiumContainer"></div>

    <script>
// 1. Firebase YapÄ±landÄ±rmasÄ±
const firebaseConfig = {
    apiKey: "AIzaSyDj58VpffB4SayaOZ6iA2JSfrFUhw0hzPw",
    authDomain: "navivortex-533de.firebaseapp.com",
    projectId: "navivortex-533de",
    storageBucket: "navivortex-533de.firebasestorage.app",
    messagingSenderId: "887483850322",
    appId: "1:887483850322:web:5c7ba61cbf0e52cc72498b",
    measurementId: "G-HZ9EW68EN1"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// 2. Cesium Temel AyarlarÄ±
Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiIzMzEyYzc1OS03OTY0LTQ5MGYtODcwMi0zMGNiYmZjNGIxMTkiLCJpZCI6Mzc2MTk2LCJpYXQiOjE3Njc4NjA4NjJ9.aZRZorILCG4gIlzwCnm1L2SCp58z-TCg6yNaDbPLxnU';









        Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'; // Kendi anahtarÄ±n kalsÄ±n

// GLOBAL DEÄžÄ°ÅžKENLERÄ° BURAYA TAÅžIDIK
let drone, waypoints = [], isLocked = false, isFlying = false, heading = 0;
let dronePos = Cesium.Cartesian3.fromDegrees(29.5100, 40.0800, 150); // BaÅŸlangÄ±Ã§ deÄŸeri
let initialHomePos = dronePos;

const viewer = new Cesium.Viewer('cesiumContainer', {
    terrain: Cesium.Terrain.fromWorldTerrain(),
    animation: false, timeline: false, baseLayerPicker: false
});

viewer.scene.globe.depthTestAgainstTerrain = false;
viewer.scene.camera.frustum.near = 0.1;

// ARAMA KUTUSU (GEOCODER) - DeÄŸiÅŸkenlerden sonra gelmeli
viewer.geocoder.viewModel.destinationFound = function(destination) {
    const cartographic = Cesium.Cartographic.fromCartesian(destination);
    const lon = Cesium.Math.toDegrees(cartographic.longitude);
    const lat = Cesium.Math.toDegrees(cartographic.latitude);
    
    dronePos = Cesium.Cartesian3.fromDegrees(lon, lat, 150);
    
    viewer.camera.flyTo({
        destination: Cesium.Cartesian3.fromDegrees(lon, lat, 1000),
        duration: 2
    });
    return destination;
};









        // Dinamik BaÅŸlangÄ±Ã§
if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition((pos) => {
        const userLon = pos.coords.longitude;
        const userLat = pos.coords.latitude;
        dronePos = Cesium.Cartesian3.fromDegrees(userLon, userLat, 150);
        viewer.camera.flyTo({
            destination: Cesium.Cartesian3.fromDegrees(userLon, userLat, 1500),
            duration: 3
        });
    }, () => {
        // Hata durumunda Bursa'ya git
        viewer.camera.flyTo({
            destination: Cesium.Cartesian3.fromDegrees(29.51, 40.08, 1500),
            duration: 2
        });
    });
}

        
        
        
        
        
        
        
        



viewer.scene.globe.depthTestAgainstTerrain = false;
viewer.scene.camera.frustum.near = 0.1;


        // --- 2. ADIM BAÅžLANGICI ---
// SaÄŸ Ã¼stteki arama kutusundan bir yer seÃ§ildiÄŸinde tetiklenir
viewer.geocoder.viewModel.destinationFound = function(destination) {
    // Bulunan yerin koordinatlarÄ±nÄ± al
    const cartographic = Cesium.Cartographic.fromCartesian(destination);
    const lon = Cesium.Math.toDegrees(cartographic.longitude);
    const lat = Cesium.Math.toDegrees(cartographic.latitude);
    
    // 1. Helikopteri o ÅŸehre/noktaya Ä±ÅŸÄ±nla
    dronePos = Cesium.Cartesian3.fromDegrees(lon, lat, 150);
    
    // 2. KamerayÄ± o noktaya uÃ§ur
    viewer.camera.flyTo({
        destination: Cesium.Cartesian3.fromDegrees(lon, lat, 1000),
        duration: 2
    });

    // Cesium'un kendi kamera hareketini durdurmak iÃ§in bunu dÃ¶ndÃ¼rÃ¼yoruz
    return destination;
};
// --- 2. ADIM BITIÅžI ---

// Global DeÄŸiÅŸkenler


let initialHomePos = dronePos;

// Kamera Odaklama: Sayfa aÃ§Ä±lÄ±r aÃ§Ä±lmaz Bursa'ya iner
viewer.camera.flyTo({
    destination: Cesium.Cartesian3.fromDegrees(29.5100, 40.0800, 1500),
    duration: 2
});

// 3. Fonksiyonlar (AddWaypoint, Reset, vb.)
function resetSystem() {
    waypoints.forEach(wp => {
        viewer.entities.remove(wp.entity);
        viewer.entities.remove(wp.anchor);
        viewer.entities.remove(wp.line);
    });
    waypoints = [];
    isLocked = false;
    isFlying = false;
    
    // UÃ§aÄŸÄ± baÅŸlangÄ±Ã§ noktasÄ±na Ä±ÅŸÄ±nla
    dronePos = Cesium.Cartesian3.fromDegrees(29.5100, 40.0800, 150);
    heading = 0;

    if(document.getElementById('start-btn')) document.getElementById('start-btn').style.display = "none";
    if(document.getElementById('lock-btn')) document.getElementById('lock-btn').innerText = "ðŸ”’ LOCK MISSION";
    
    // KamerayÄ± tekrar uÃ§aÄŸa odakla
    viewer.camera.flyTo({
        destination: Cesium.Cartesian3.fromDegrees(29.5100, 40.0800, 1000),
        duration: 2
    });
}

function addWaypoint(fixedPos) {
    if (waypoints.length === 0) initialHomePos = dronePos;

    let pointColor = Cesium.Color.YELLOW;
    let labelText = "WAYPOINT";
    if (waypoints.length === 0) { pointColor = Cesium.Color.DEEPSKYBLUE; labelText = "START HELIPORT"; }

    const wp = {
        pos: fixedPos,
        entity: viewer.entities.add({
            position: new Cesium.CallbackProperty(() => wp.pos, false),
            point: { pixelSize: 12, color: pointColor, outlineColor: Cesium.Color.WHITE, outlineWidth: 2, disableDepthTestDistance: Number.POSITIVE_INFINITY },
            label: { text: labelText, font: '12px sans-serif', verticalOrigin: Cesium.VerticalOrigin.BOTTOM, pixelOffset: new Cesium.Cartesian2(0, -15), disableDepthTestDistance: Number.POSITIVE_INFINITY }
        }),
        anchor: viewer.entities.add({
            polyline: {
                positions: new Cesium.CallbackProperty(() => {
                    const c = Cesium.Cartographic.fromCartesian(wp.pos);
                    const terrainHeight = viewer.scene.sampleHeight(c) || 0;
                    return [Cesium.Cartesian3.fromRadians(c.longitude, c.latitude, terrainHeight), wp.pos];
                }, false),
                width: 1,
                material: new Cesium.PolylineDashMaterialProperty({ color: Cesium.Color.WHITE.withAlpha(0.5) }),
                disableDepthTestDistance: Number.POSITIVE_INFINITY 
            }
        }),
        line: viewer.entities.add({
            polyline: {
                positions: new Cesium.CallbackProperty(() => {
                    let idx = waypoints.indexOf(wp);
                    let start = (idx === 0) ? initialHomePos : waypoints[idx-1].pos;
                    return [start, wp.pos];
                }, false),
                width: 8,
                material: Cesium.Color.fromCssColorString('#0ea5e9').withAlpha(0.6),
                disableDepthTestDistance: Number.POSITIVE_INFINITY,
                arcType: Cesium.ArcType.NONE
            }
        })
    };
    waypoints.push(wp);

    if (waypoints.length > 1) {
        waypoints[waypoints.length-1].entity.label.text = "DESTINATION HELIPORT";
        waypoints[waypoints.length-1].entity.point.color = Cesium.Color.RED;
        if (waypoints.length > 2) {
            waypoints[waypoints.length-2].entity.label.text = "CORRIDOR POINT";
            waypoints[waypoints.length-2].entity.point.color = Cesium.Color.YELLOW;
        }
    }
}

// 4. Bulut Ä°ÅŸlemleri (Save/Load)
async function saveRoute() {
    const user = auth.currentUser;
    const routeName = document.getElementById('route-name').value;
    if (!user || !routeName || waypoints.length === 0) return alert("Check entry or route!");

    const routeData = waypoints.map(wp => {
        const carto = Cesium.Cartographic.fromCartesian(wp.pos);
        return { lon: Cesium.Math.toDegrees(carto.longitude), lat: Cesium.Math.toDegrees(carto.latitude), alt: carto.height };
    });

    try {
        await db.collection("users").doc(user.uid).collection("missions").add({
            name: routeName, path: routeData, createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        alert("Saved!");
        loadMissionsList();
    } catch (e) { alert(e.message); }
}

async function loadMissionsList() {
    const user = auth.currentUser;
    if (!user) return;
    const snapshot = await db.collection("users").doc(user.uid).collection("missions").orderBy("createdAt", "desc").get();
    const listDiv = document.getElementById('mission-list');
    listDiv.innerHTML = "";
    snapshot.forEach(doc => {
        const mission = doc.data();
        const btn = document.createElement('button');
        btn.innerText = "ðŸ“‚ " + mission.name;
        btn.className = "btn";
        btn.style = "font-size: 11px; padding: 8px; margin-bottom: 5px; background: #1e293b; border: 1px solid #38bdf8; text-align: left; width: 100%; cursor: pointer; color:white;";
        btn.onclick = () => drawSavedRoute(mission.path);
        listDiv.appendChild(btn);
    });
}

function drawSavedRoute(pathData) {
    resetSystem();
    pathData.forEach(p => addWaypoint(Cesium.Cartesian3.fromDegrees(p.lon, p.lat, p.alt)));
}

// 5. Auth Ä°ÅŸlemleri
auth.onAuthStateChanged((user) => {
    const loggedOutView = document.getElementById('logged-out-view');
    const userInfo = document.getElementById('user-info');
    const saveSection = document.getElementById('save-section');
    if (user) {
        loggedOutView.style.display = 'none';
        userInfo.style.display = 'flex';
        saveSection.style.display = 'block';
        document.getElementById('user-name').innerText = "Pilot: " + (user.displayName || user.email.split('@')[0]);
        loadMissionsList();
    } else {
        loggedOutView.style.display = 'block';
        userInfo.style.display = 'none';
        saveSection.style.display = 'none';
    }
});

function loginWithGoogle() { auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); }
function logout() { auth.signOut(); }

// 6. Helikopter ve Kontroller
drone = viewer.entities.add({
    name: "Helicopter",
    position: new Cesium.CallbackProperty(() => dronePos, false),
    orientation: new Cesium.CallbackProperty(() => {
        return Cesium.Transforms.headingPitchRollQuaternion(dronePos, new Cesium.HeadingPitchRoll(Cesium.Math.toRadians(heading - 90), 0, 0));
    }, false),
    model: { 
    uri: 'https://raw.githubusercontent.com/CesiumGS/cesium/main/Apps/SampleData/models/CesiumAir/Cesium_Air.glb', 
    minimumPixelSize: 100, 
    scale: 1.5,
    heightReference: Cesium.HeightReference.NONE // YÃ¼ksekliÄŸi manuel kontrol etmemizi saÄŸlar
}
});

const handler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);
handler.setInputAction((click) => {
    if (isLocked || isFlying) return;
    const picked = viewer.scene.pickPosition(click.position);
    if (Cesium.defined(picked)) {
        const c = Cesium.Cartographic.fromCartesian(picked);
        const dAlt = Cesium.Cartographic.fromCartesian(dronePos).height;
        addWaypoint(Cesium.Cartesian3.fromDegrees(Cesium.Math.toDegrees(c.longitude), Cesium.Math.toDegrees(c.latitude), dAlt));
    }
}, Cesium.ScreenSpaceEventType.LEFT_CLICK);




        // 1. Klavyeyi Dinle
const keysPressed = {};
document.addEventListener('keydown', (e) => { keysPressed[e.key.toLowerCase()] = true; });
document.addEventListener('keyup', (e) => { keysPressed[e.key.toLowerCase()] = false; });

// 2. Ana UÃ§uÅŸ DÃ¶ngÃ¼sÃ¼ (Her karede Ã§alÄ±ÅŸÄ±r)
viewer.scene.preRender.addEventListener(function() {
    if (isLocked || isFlying || !dronePos) return;

    const moveStep = 0.0001; // Yatay hÄ±z
    const altStep = 1.0;     // Dikey hÄ±z
    const rad = Cesium.Math.toRadians(heading);
    
    let c = Cesium.Cartographic.fromCartesian(dronePos);
    let lon = Cesium.Math.toDegrees(c.longitude);
    let lat = Cesium.Math.toDegrees(c.latitude);
    let alt = c.height;

    // Hareket Kontrolleri
    if (keysPressed['w']) { lat += moveStep * Math.cos(rad); lon += moveStep * Math.sin(rad); }
    if (keysPressed['s']) { lat -= moveStep * Math.cos(rad); lon -= moveStep * Math.sin(rad); }
    if (keysPressed['a']) heading -= 1.5;
    if (keysPressed['d']) heading += 1.5;
    if (keysPressed['q']) alt += altStep;
    if (keysPressed['e']) alt -= altStep;

    // Pozisyonu gÃ¼ncelle
    dronePos = Cesium.Cartesian3.fromDegrees(lon, lat, alt);

    // YÃ¼kseklik Hesaplama (AGL/MSL)
    const groundHeight = viewer.scene.sampleHeight(c, [drone]) || 0;
    const currentAGL = alt - groundHeight;

    // Paneli GÃ¼ncelle
    document.getElementById('agl-txt').innerText = "AGL: " + Math.round(currentAGL) + " m";
    document.getElementById('msl-txt').innerText = "MSL: " + Math.round(alt) + " m";
    
    // Manuel giriÅŸ kutusunu da senkronize tutalÄ±m
    document.getElementById('manual-msl').value = Math.round(alt);
});




        

async function startFlight() {
    isFlying = true;
    viewer.trackedEntity = drone;
    let current = dronePos;
    for (const wp of waypoints) {
        const start = current;
        const end = wp.pos;
        const speed = parseFloat(document.getElementById('flight-speed').value);
        const duration = Cesium.Cartesian3.distance(start, end) / speed;
        await new Promise(res => {
            let sTime = performance.now();
            function frame(now) {
                let t = Math.min((now - sTime) / (duration * 1000), 1);
                const cS = Cesium.Cartographic.fromCartesian(start);
                const cE = Cesium.Cartographic.fromCartesian(end);
                const y = Math.sin(cE.longitude - cS.longitude) * Math.cos(cE.latitude);
                const x = Math.cos(cS.latitude) * Math.sin(cE.latitude) - Math.sin(cS.latitude) * Math.cos(cE.latitude) * Math.cos(cE.longitude - cS.longitude);
                heading = Cesium.Math.toDegrees(Math.atan2(y, x));
                dronePos = Cesium.Cartesian3.lerp(start, end, t, new Cesium.Cartesian3());
                if (t < 1) requestAnimationFrame(frame); else res();
            }
            requestAnimationFrame(frame);
        });
        current = end;
    }
    isFlying = false;
    viewer.trackedEntity = undefined;
}

function toggleLock() {
    if (waypoints.length === 0) return;
    isLocked = !isLocked;
    document.getElementById('start-btn').style.display = isLocked ? "block" : "none";
    document.getElementById('lock-btn').innerText = isLocked ? "ðŸ”“ UNLOCK" : "ðŸ”’ LOCK MISSION";
}

function updateManualAlt(val) {
    if(!val || !dronePos) return;
    const numericAlt = parseFloat(val);
    const c = Cesium.Cartographic.fromCartesian(dronePos);
    
    dronePos = Cesium.Cartesian3.fromDegrees(
        Cesium.Math.toDegrees(c.longitude), 
        Cesium.Math.toDegrees(c.latitude), 
        numericAlt
    );
    console.log("Manuel YÃ¼kseklik AyarlandÄ±:", numericAlt);
}
    
    // Dashboard yazÄ±larÄ±nÄ± anÄ±nda gÃ¼ncelle
    document.getElementById('msl-txt').innerText = "MSL: " + Math.round(numericAlt) + " m";
    
    // EÄŸer uÃ§uÅŸta deÄŸilsek kamerayÄ± uÃ§aÄŸa hafifÃ§e yaklaÅŸtÄ±r
    if(!isFlying) {
        viewer.camera.lookAtTransform(Cesium.Matrix4.IDENTITY); // KamerayÄ± serbest bÄ±rak
    }
}

    </script>
</body>
</html>









