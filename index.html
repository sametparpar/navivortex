<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>NaviVortex V60 | Universal Mission Planner</title>
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.114/Build/Cesium/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.114/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    <style>
        body, html, #cesiumContainer { width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden; background-color: #020617; }
        
        /* SOL PANEL: PARAMETRELER */
        #params-panel {
            position: absolute; top: 20px; left: 20px; width: 280px;
            background: rgba(15, 23, 42, 0.95); padding: 20px; border-radius: 12px;
            border: 1px solid #38bdf8; color: white; font-family: sans-serif; z-index: 100;
        }

        /* SAĞ PANEL: KOORDİNAT TABLOSU */
        #data-table {
            position: absolute; top: 20px; right: 20px; width: 320px;
            background: rgba(15, 23, 42, 0.95); padding: 15px; border-radius: 12px;
            border: 1px solid #10b981; color: white; font-family: monospace; z-index: 100;
            max-height: 80vh; overflow-y: auto;
        }

        .input-group { margin-bottom: 15px; }
        label { display: block; font-size: 11px; color: #94a3b8; margin-bottom: 5px; text-transform: uppercase; }
        input, select { width: 100%; padding: 8px; background: #1e293b; border: 1px solid #334155; color: #38bdf8; border-radius: 4px; }
        
        .btn-export { background: #0ea5e9; color: white; border: none; padding: 10px; width: 100%; 
                      border-radius: 6px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn-export:hover { background: #0284c7; }
        
        .waypoint-item { border-bottom: 1px solid #334155; padding: 8px 0; font-size: 12px; }
        .energy-warn { color: #ef4444; font-weight: bold; font-size: 12px; margin-top: 10px; display:none; }
    </style>
</head>
<body>

<div id="params-panel">
    <h2 style="color:#38bdf8; margin-top:0;">NAVIVORTEX V60</h2>
    
    <div class="input-group">
        <label>Drone Weight (kg)</label>
        <input type="number" id="uav-weight" value="1.5" step="0.1" onchange="calculateLogistics()">
    </div>
    
    <div class="input-group">
        <label>Battery Capacity (mAh)</label>
        <input type="number" id="uav-bat" value="5000" onchange="calculateLogistics()">
    </div>

    <div class="input-group">
        <label>Cruise Speed (m/s)</label>
        <input type="number" id="uav-speed" value="15" onchange="calculateLogistics()">
    </div>

    <hr style="border:0; border-top:1px solid #334155;">
    
    <label>Universal Export</label>
    <button class="btn-export" onclick="exportMission('LITCHI')">EXPORT LITCHI (.CSV)</button>
    <button class="btn-export" onclick="exportMission('DJI')">EXPORT DJI PILOT (.KMZ)</button>
    <button class="btn-export" onclick="exportMission('ARDU')">EXPORT ARDUPILOT (.WAYPOINT)</button>
    
    <div id="energy-alert" class="energy-warn">⚠️ INSUFFICIENT ENERGY!</div>
</div>

<div id="data-table">
    <div style="font-weight:bold; border-bottom:1px solid #10b981; padding-bottom:5px; margin-bottom:10px;">MISSION LOGBOOK</div>
    <div id="wp-list">
        <div style="color:#94a3b8; font-style:italic;">Click map to add waypoints...</div>
    </div>
    <div id="total-stats" style="margin-top:15px; padding-top:10px; border-top:1px dashed #334155;">
        Dist: 0.00 km | Time: 0.0 min
    </div>
</div>

<div id="cesiumContainer"></div>

<script>
Cesium.Ion.defaultAccessToken = 'EYE...'; // Buraya kendi token'ını koy

const viewer = new Cesium.Viewer('cesiumContainer', {
    terrain: Cesium.Terrain.fromWorldTerrain(),
    animation: false, timeline: false, baseLayerPicker: false, infoBox: false
});

let waypoints = [];
let routeLine = null;

// TIKLAMA İLE NOKTA EKLEME
const handler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);
handler.setInputAction((click) => {
    const picked = viewer.scene.pickPosition(click.position);
    if (Cesium.defined(picked)) {
        addWaypoint(picked);
    }
}, Cesium.ScreenSpaceEventType.LEFT_CLICK);

function addWaypoint(pos) {
    const carto = Cesium.Cartographic.fromCartesian(pos);
    const wp = {
        lat: Cesium.Math.toDegrees(carto.latitude),
        lon: Cesium.Math.toDegrees(carto.longitude),
        alt: Math.round(carto.height + 50), // Varsayılan 50m AGL
        cartesian: pos
    };
    
    waypoints.push(wp);
    renderVisuals();
    updateUI();
    calculateLogistics();
}

function renderVisuals() {
    // Mevcut rotayı temizle
    if (routeLine) viewer.entities.remove(routeLine);
    
    // Noktaları Çiz
    const positions = waypoints.map(w => Cesium.Cartesian3.fromDegrees(w.lon, w.lat, w.alt));
    
    // Çizgiyi Oluştur
    if (positions.length > 1) {
        routeLine = viewer.entities.add({
            polyline: {
                positions: positions,
                width: 3,
                material: Cesium.Color.fromCssColorString('#38bdf8'),
                disableDepthTestDistance: Number.POSITIVE_INFINITY
            }
        });
    }

    // Pin Ekle
    const lastWp = waypoints[waypoints.length - 1];
    viewer.entities.add({
        position: Cesium.Cartesian3.fromDegrees(lastWp.lon, lastWp.lat, lastWp.alt),
        point: { pixelSize: 8, color: Cesium.Color.fromCssColorString('#10b981') }
    });
}

function updateUI() {
    const list = document.getElementById('wp-list');
    list.innerHTML = "";
    let totalDist = 0;

    waypoints.forEach((wp, i) => {
        if (i > 0) {
            const p1 = Cesium.Cartesian3.fromDegrees(waypoints[i-1].lon, waypoints[i-1].lat, waypoints[i-1].alt);
            const p2 = Cesium.Cartesian3.fromDegrees(wp.lon, wp.lat, wp.alt);
            totalDist += Cesium.Cartesian3.distance(p1, p2);
        }

        list.innerHTML += `
            <div class="waypoint-item">
                <b>#${i+1}</b> - LAT: ${wp.lat.toFixed(5)}<br>
                LON: ${wp.lon.toFixed(5)} | ALT: ${wp.alt}m
            </div>
        `;
    });

    const speed = parseFloat(document.getElementById('uav-speed').value);
    const time = (totalDist / speed) / 60;
    document.getElementById('total-stats').innerText = `Dist: ${(totalDist/1000).toFixed(2)} km | Time: ${time.toFixed(1)} min`;
}

function calculateLogistics() {
    // BASİT ENERJİ ANALİZİ (Örnek Algoritma)
    const weight = parseFloat(document.getElementById('uav-weight').value);
    const capacity = parseFloat(document.getElementById('uav-bat').value);
    const distMeters = (parseFloat(document.getElementById('total-stats').innerText.split(' ')[1]) * 1000) || 0;
    
    // Tüketim tahmini (Uydurma fizik katsayısı: ağırlık * mesafe / 100)
    const estConsumption = (weight * distMeters) / 10; 
    
    const alertBox = document.getElementById('energy-alert');
    if (estConsumption > capacity) {
        alertBox.style.display = "block";
    } else {
        alertBox.style.display = "none";
    }
}

function exportMission(type) {
    alert(type + " Export feature coming soon! This will download the converted file.");
}
</script>
</body>
</html>
