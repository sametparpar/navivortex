<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>NaviVortex V50 - THE CORE</title>
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.114/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.114/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
  <style>
    body, html, #cesiumContainer { width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden; background-color: #000; }
    #dashboard {
        position: absolute; top: 20px; left: 20px; width: 280px; 
        background: rgba(15, 23, 42, 0.96); backdrop-filter: blur(20px); z-index: 100; padding: 25px;
        border: 2px solid #38bdf8; border-radius: 16px; font-family: 'Inter', sans-serif; color: white;
        box-shadow: 0 15px 35px rgba(0,0,0,0.8);
    }
    .telemetry { background: rgba(30, 41, 59, 0.9); padding: 12px; border-radius: 10px; margin: 10px 0; border-left: 5px solid #38bdf8; }
    .label { font-size: 10px; color: #94a3b8; text-transform: uppercase; font-weight: bold; }
    .value { font-size: 18px; font-weight: 900; color: #f1f5f9; }
    .btn { width: 100%; padding: 14px; margin-top: 10px; border-radius: 10px; border: none; cursor: pointer; font-weight: 800; text-transform: uppercase; transition: 0.2s; }
    #lock-btn { background: #0ea5e9; color: white; }
    #start-btn { background: #10b981; color: white; display: none; }
    #restart-btn { background: #f59e0b; color: black; display: none; }
    #home-btn { background: #6366f1; color: white; display: none; }
    .clear-btn { background: transparent; color: #ef4444; border: 1px solid #ef4444; margin-top: 20px; font-size: 11px; }
    .clear-btn:hover { background: #ef4444; color: white; }
  </style>
</head>
<body>
  <div id="dashboard">
    <h2 style="color:#38bdf8; margin:0 0 15px 0; font-size: 22px; font-weight: 900;">NAVI<span style="color:#fff">VORTEX</span></h2>
    <div class="telemetry"><div class="label">ALTITUDE (MSL)</div><div id="alt-txt" class="value">100 m</div></div>
    <div class="telemetry"><div class="label">MISSION STATE</div><div id="status-txt" class="value" style="color:#38bdf8;">POSITIONING</div></div>
    
    <button id="lock-btn" class="btn" onclick="toggleLock()">üîí LOCK MISSION</button>
    <button id="start-btn" class="btn" onclick="runFlight()">üöÄ START MISSION</button>
    <button id="restart-btn" class="btn" onclick="runFlight(true)">üîÑ RESTART MISSION</button>
    <button id="home-btn" class="btn" onclick="camToOrigin()">üè† CAMERA TO ORIGIN</button>
    <button class="btn clear-btn" onclick="fullReset()">üóëÔ∏è RESET ALL</button>
  </div>
  <div id="cesiumContainer"></div>

  <script>
    Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiIzMzEyYzc1OS03OTY0LTQ5MGYtODcwMi0zMGNiYmZjNGIxMTkiLCJpZCI6Mzc2MTk2LCJpYXQiOjE3Njc4NjA4NjJ9.aZRZorILCG4gIlzwCnm1L2SCp58z-TCg6yNaDbPLxnU';
    const GOOGLE_API_KEY = 'AIzaSyDDPGFsMFFW8Q8s9Y-2aonzk6LofSBuhps';

    const viewer = new Cesium.Viewer('cesiumContainer', {
        terrain: Cesium.Terrain.fromWorldTerrain(),
        animation: false, timeline: false, baseLayerPicker: false, geocoder: true,
        scene3DOnly: true
    });

    // Core Stability Settings
    viewer.scene.globe.depthTestAgainstTerrain = false; // Essential for red/green line visibility
    viewer.scene.camera.frustum.near = 0.1; // No disappearing drone near ground
    
    let drone, heading = 0, waypoints = [], isLocked = false, isFlying = false;
    let homePos = Cesium.Cartesian3.fromDegrees(28.9784, 41.0082, 100);
    let zoomRange = 100;

    // Bu satƒ±r kameranƒ±n objelere 10cm'e kadar yakla≈ümasƒ±nƒ± saƒülar
viewer.scene.camera.frustum.near = 0.1;
    
    async function init() {
        const tileset = await Cesium.createGooglePhotorealistic3DTileset(GOOGLE_API_KEY);
        viewer.scene.primitives.add(tileset);
        
        drone = viewer.entities.add({
            position: new Cesium.CallbackProperty(() => homePos, false),
            orientation: new Cesium.CallbackProperty(() => {
                return Cesium.Transforms.headingPitchRollQuaternion(homePos, new Cesium.HeadingPitchRoll(Cesium.Math.toRadians(heading), 0, 0));
            }, false),
            model: { uri: 'https://raw.githubusercontent.com/CesiumGS/cesium/main/Apps/SampleData/models/CesiumDrone/CesiumDrone.glb', minimumPixelSize: 100 }
        });



// Derinlik testini k√ºresel olarak kapatƒ±yoruz ki √ßizgiler her zaman √ºstte kalsƒ±n
viewer.scene.globe.depthTestAgainstTerrain = false;


      
        // Search Redirect Fix
viewer.geocoder.viewModel.destinationFound = (viewModel, destination) => {
    const cartographic = Cesium.Cartographic.fromCartesian(destination);
    // Drone'u ve kalkƒ±≈ü noktasƒ±nƒ± yeni koordinata ta≈üƒ±
    homePos = Cesium.Cartesian3.fromRadians(cartographic.longitude, cartographic.latitude, 100);
    
    // Kamerayƒ± oraya u√ßur
    viewer.camera.flyTo({ 
        destination: Cesium.Cartesian3.fromRadians(cartographic.longitude, cartographic.latitude, 500) 
    });
    
    // Eski rotayƒ± temizle
    fullReset(); 
};




      

        const handler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);

        // WP Placement & Dash Line Logic
        handler.setInputAction((click) => {
            if (isLocked || isFlying) return;
            const pickedPos = viewer.scene.pickPosition(click.position);
            if (!Cesium.defined(pickedPos)) return;

            const wp = {
                pos: pickedPos,
                entity: viewer.entities.add({
                    position: new Cesium.CallbackProperty(() => wp.pos, false),
                    point: { pixelSize: 12, color: Cesium.Color.YELLOW, disableDepthTestDistance: Number.POSITIVE_INFINITY },
                    label: { text: new Cesium.CallbackProperty(() => Math.round(Cesium.Cartographic.fromCartesian(wp.pos).height) + "m", false), font: 'bold 12px sans-serif', pixelOffset: new Cesium.Cartesian2(0, -25), disableDepthTestDistance: Number.POSITIVE_INFINITY }
                }),
                anchor: viewer.entities.add({
                    polyline: {
                        positions: new Cesium.CallbackProperty(() => {
                            const c = Cesium.Cartographic.fromCartesian(wp.pos);
                            return [Cesium.Cartesian3.fromRadians(c.longitude, c.latitude, 0), wp.pos];
                        }, false),
                        width: 2, material: new Cesium.PolylineDashMaterialProperty({color: Cesium.Color.WHITE}), disableDepthTestDistance: Number.POSITIVE_INFINITY
                    }
                }),
                path: viewer.entities.add({
                    polyline: {
                        positions: new Cesium.CallbackProperty(() => {
                            let idx = waypoints.indexOf(wp);
                            let start = (idx === 0) ? homePos : waypoints[idx-1].pos;
                            return [start, wp.pos];
                        }, false),
                        width: 8, material: Cesium.Color.GREEN, disableDepthTestDistance: Number.POSITIVE_INFINITY
                    }
                })
            };
            waypoints.push(wp);
            updateSafety();
        }, Cesium.ScreenSpaceEventType.LEFT_CLICK);

        // Wheel Adjustments
        viewer.canvas.addEventListener('wheel', (e) => {
            if (isFlying) {
                zoomRange = Math.max(10, zoomRange + (e.deltaY > 0 ? 15 : -15));
                return;
            }
            if (isLocked || waypoints.length === 0) return;
            viewer.scene.screenSpaceCameraController.enableZoom = false;
            const last = waypoints[waypoints.length - 1];
            const c = Cesium.Cartographic.fromCartesian(last.pos);
            last.pos = Cesium.Cartesian3.fromRadians(c.longitude, c.latitude, Math.max(0, c.height + (e.deltaY < 0 ? 5 : -5)));
            updateSafety();
            setTimeout(() => { if(!isLocked) viewer.scene.screenSpaceCameraController.enableZoom = true; }, 200);
        }, { passive: false });

        // WASD Control
        document.addEventListener('keydown', (e) => {
            if (isFlying || isLocked) return;
            const c = Cesium.Cartographic.fromCartesian(homePos);
            let lon = Cesium.Math.toDegrees(c.longitude), lat = Cesium.Math.toDegrees(c.latitude), alt = c.height;
            const s = 0.00005, k = e.key.toLowerCase();
            if (k === 'a') heading -= 5; if (k === 'd') heading += 5;
            if (k === 'w') { lat += s * Math.cos(Cesium.Math.toRadians(heading)); lon += s * Math.sin(Cesium.Math.toRadians(heading)); }
            if (k === 's') { lat -= s * Math.cos(Cesium.Math.toRadians(heading)); lon -= s * Math.sin(Cesium.Math.toRadians(heading)); }
            if (k === 'q') alt += 2; if (k === 'e') alt = Math.max(0, alt - 2);
            homePos = Cesium.Cartesian3.fromDegrees(lon, lat, alt);
            document.getElementById('alt-txt').innerText = Math.round(alt) + " m";
        });
    }

    function updateSafety() {
        waypoints.forEach((wp, i) => {
            let start = (i === 0) ? homePos : waypoints[i-1].pos;
            let dist = Cesium.Cartesian3.distance(start, wp.pos);
            let dir = Cesium.Cartesian3.normalize(Cesium.Cartesian3.subtract(wp.pos, start, new Cesium.Cartesian3()), new Cesium.Cartesian3());
            let hit = viewer.scene.pickFromRay(new Cesium.Ray(start, dir));
            let blocked = Cesium.defined(hit) && Cesium.Cartesian3.distance(start, hit.position) < (dist - 1.0);
            wp.path.polyline.material = blocked ? Cesium.Color.RED : Cesium.Color.GREEN;
        });
    }

    function toggleLock() {
        if (waypoints.length === 0) return;
        isLocked = !isLocked;
        document.getElementById('start-btn').style.display = isLocked ? "block" : "none";
        document.getElementById('status-txt').innerText = isLocked ? "MISSION LOCKED" : "PLANNING";
        viewer.scene.screenSpaceCameraController.enableZoom = true;
    }

    async function runFlight(isRestart = false) {
        if(isRestart) { 
            const carto = Cesium.Cartographic.fromCartesian(waypoints[0].anchor.polyline.positions.getValue()[0]);
            homePos = Cesium.Cartesian3.fromRadians(carto.longitude, carto.latitude, 100); 
        }
        isFlying = true;
        document.getElementById('start-btn').style.display = "none";
        document.getElementById('lock-btn').style.display = "none";
        document.getElementById('status-txt').innerText = "AUTO-FLIGHT...";

        let currentSegStart = homePos;
        for (const wp of waypoints) {
            const start = currentSegStart;
            const end = wp.pos;
            const duration = Cesium.Cartesian3.distance(start, end) / 20;
            
            await new Promise(res => {
                let startTime = performance.now();
                function animate(now) {
                    let t = Math.min((now - startTime) / (duration * 1000), 1);
                    homePos = Cesium.Cartesian3.lerp(start, end, t, new Cesium.Cartesian3());
                    const dir = Cesium.Cartesian3.normalize(Cesium.Cartesian3.subtract(end, start, new Cesium.Cartesian3()), new Cesium.Cartesian3());
                    heading = Cesium.Math.toDegrees(Math.atan2(dir.x, dir.y));
                    
                    // Dynamic Camera Orbit Follow
                    viewer.camera.lookAt(homePos, new Cesium.Cartesian3(-zoomRange, 0, zoomRange/2));
                    
                    if (t < 1) requestAnimationFrame(animate); else res();
                }
                requestAnimationFrame(animate);
            });
            currentSegStart = end;
        }
        isFlying = false;
        viewer.camera.lookAtTransform(Cesium.Matrix4.IDENTITY);
        document.getElementById('restart-btn').style.display = "block";
        document.getElementById('home-btn').style.display = "block";
        document.getElementById('status-txt').innerText = "MISSION FINISHED";
    }

    function camToOrigin() {
        viewer.camera.flyTo({ destination: homePos, offset: new Cesium.HeadingPitchRange(0, -0.5, 300) });
    }

    function fullReset() {
        waypoints.forEach(wp => { viewer.entities.remove(wp.entity); viewer.entities.remove(wp.anchor); viewer.entities.remove(wp.path); });
        waypoints = []; isLocked = false; isFlying = false;
        document.getElementById('status-txt').innerText = "POSITIONING";
        document.getElementById('start-btn').style.display = "none";
        document.getElementById('restart-btn').style.display = "none";
        document.getElementById('home-btn').style.display = "none";
        document.getElementById('lock-btn').style.display = "block";
    }

    init();
  </script>
</body>
</html>

