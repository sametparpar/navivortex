<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>NaviVortex V26 - Control Lock</title>
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.114/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.114/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
  <style>
    body, html, #cesiumContainer { width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden; background-color: #000; }
    #dashboard {
        position: absolute; top: 20px; left: 20px; width: 280px; 
        background: rgba(15, 23, 42, 0.95); z-index: 100; padding: 20px;
        border: 1px solid #38bdf8; border-radius: 12px; font-family: 'Inter', sans-serif; color: white;
    }
    .telemetry { background: #1e293b; padding: 10px; border-radius: 8px; margin: 10px 0; border-left: 4px solid #38bdf8; }
    .label { font-size: 10px; color: #94a3b8; text-transform: uppercase; }
    .value { font-size: 16px; font-weight: bold; color: #f1f5f9; }
    #guide { font-size: 11px; color: #64748b; margin-top: 15px; border-top: 1px solid #334155; padding-top: 10px; line-height: 1.4; }
  </style>
</head>
<body>
  <div id="dashboard">
    <h2 style="color:#38bdf8; margin:0; font-size: 18px;">NAVIVORTEX V26</h2>
    <div class="telemetry"><div class="label">Drone Alt (AMSL)</div><div id="alt-txt" class="value">100 m</div></div>
    <div class="telemetry"><div class="label">Adjusting Point Alt</div><div id="wp-alt-txt" class="value">---</div></div>
    <div id="guide">
        • <b>Sol Tık:</b> Nokta Ekle<br>
        • <b>Mouse Tekerleği:</b> Yüksekliği Değiştir (Zoom Devre Dışı Kalır)<br>
        • <b>Sağ Tık / Sürükle:</b> Haritayı Hareket Ettir
    </div>
    <button onclick="location.reload()" style="width:100%; padding:8px; background:#334155; color:white; border:none; border-radius:6px; cursor:pointer; font-weight:bold; margin-top:10px;">GÖREVİ SIFIRLA</button>
  </div>
  <div id="cesiumContainer"></div>

  <script>
    Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiIzMzEyYzc1OS03OTY0LTQ5MGYtODcwMi0zMGNiYmZjNGIxMTkiLCJpZCI6Mzc2MTk2LCJpYXQiOjE3Njc4NjA4NjJ9.aZRZorILCG4gIlzwCnm1L2SCp58z-TCg6yNaDbPLxnU';
    const GOOGLE_API_KEY = 'AIzaSyDDPGFsMFFW8Q8s9Y-2aonzk6LofSBuhps';

    const viewer = new Cesium.Viewer('cesiumContainer', {
      terrain: Cesium.Terrain.fromWorldTerrain(),
      animation: false, timeline: false, baseLayerPicker: false
    });

    let droneEntity, heading = 0, waypoints = [], activeEntities = [];

    async function init() {
      const tileset = await Cesium.createGooglePhotorealistic3DTileset(GOOGLE_API_KEY);
      viewer.scene.primitives.add(tileset);
      
      const startPos = Cesium.Cartesian3.fromDegrees(28.9784, 41.0082, 100);
      droneEntity = viewer.entities.add({
          position: startPos,
          model: { uri: 'https://raw.githubusercontent.com/CesiumGS/cesium/main/Apps/SampleData/models/CesiumDrone/CesiumDrone.glb', minimumPixelSize: 90 }
      });
      viewer.trackedEntity = droneEntity;

      const handler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);

      // --- NOKTA EKLEME ---
      handler.setInputAction((click) => {
          const pickedPos = viewer.scene.pickPosition(click.position);
          if (Cesium.defined(pickedPos)) {
              const dronePos = droneEntity.position.getValue(viewer.clock.currentTime);
              const dCarto = Cesium.Cartographic.fromCartesian(dronePos);
              const pCarto = Cesium.Cartographic.fromCartesian(pickedPos);
              
              const finalPos = Cesium.Cartesian3.fromRadians(pCarto.longitude, pCarto.latitude, dCarto.height);
              
              const wp = {
                  position: finalPos,
                  entity: viewer.entities.add({
                      position: finalPos,
                      point: { pixelSize: 12, color: Cesium.Color.YELLOW, disableDepthTestDistance: 1e9 },
                      label: { text: Math.round(dCarto.height) + "m", font: '10pt sans-serif', pixelOffset: new Cesium.Cartesian2(0, -20), disableDepthTestDistance: 1e9 }
                  })
              };
              
              waypoints.push(wp);
              document.getElementById('wp-alt-txt').innerText = Math.round(dCarto.height) + " m";
              updateLines();
          }
      }, Cesium.ScreenSpaceEventType.LEFT_CLICK);

      // --- ZOOM ENGELLEME VE YÜKSEKLİK AYARI ---
      // Tekerlek hareketini yakalıyoruz
      viewer.canvas.addEventListener('wheel', function(e) {
          if (waypoints.length > 0) {
              // Haritanın kendi zoom özelliğini geçici olarak devre dışı bırakıyoruz
              viewer.scene.screenSpaceCameraController.enableInputs = false;
              
              const lastWP = waypoints[waypoints.length - 1];
              const carto = Cesium.Cartographic.fromCartesian(lastWP.position);
              
              // Tekerlek yukarı -> Yükseklik artar, Tekerlek aşağı -> Yükseklik azalır
              const delta = e.deltaY < 0 ? 5 : -5;
              const newAlt = carto.height + delta;
              const newPos = Cesium.Cartesian3.fromRadians(carto.longitude, carto.latitude, newAlt);
              
              lastWP.position = newPos;
              lastWP.entity.position = newPos;
              lastWP.entity.label.text = Math.round(newAlt) + "m";
              document.getElementById('wp-alt-txt').innerText = Math.round(newAlt) + " m";
              
              updateLines();

              // Kısa bir süre sonra kamera kontrolünü geri açıyoruz (serbest hareket için)
              setTimeout(() => {
                  viewer.scene.screenSpaceCameraController.enableInputs = true;
              }, 100);
          }
      }, false);

      function updateLines() {
          activeEntities.forEach(e => viewer.entities.remove(e
