<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>NaviVortex V12.25</title>
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.114/Build/Cesium/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.114/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    <style>
        body, html, #cesiumContainer { width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden; background-color: #000; }
        #dashboard {
            position: absolute; top: 20px; left: 20px; width: 260px; 
            background: rgba(15, 23, 42, 0.9); z-index: 100; padding: 20px;
            border-radius: 12px; font-family: sans-serif; color: white; border: 1px solid #38bdf8;
        }
        .btn { width: 100%; padding: 12px; margin-top: 10px; border-radius: 6px; border: none; cursor: pointer; font-weight: bold; text-transform: uppercase; }
        #start-btn { background: #10b981; color: white; display: none; }
        #lock-btn { background: #0ea5e9; color: white; }
        .reset-btn { background: #ef4444; color: white; margin-top: 20px; font-size: 10px; }
    </style>
</head>
<body>
    <div id="dashboard">
        <h2 style="margin:0 0 10px 0; color:#38bdf8;">NAVIVORTEX V54</h2>
<div id="agl-txt" style="color: #10b981; font-weight: bold;">AGL: 100 m (Yerden)</div>
<div id="msl-txt" style="color: #38bdf8; font-size: 0.9em;">MSL: 100 m (Denizden)</div>
        <button id="lock-btn" class="btn" onclick="toggleLock()">ðŸ”’ LOCK MISSION</button>
        <button id="start-btn" class="btn" onclick="startFlight()">ðŸš€ START FLIGHT</button>
        <div style="margin-top: 15px; border-top: 1px solid #334155; padding-top: 10px;">
    <input type="text" id="search-city" placeholder="Åžehir adÄ± veya Enlem, Boylam" 
       onkeypress="if(event.key === 'Enter') goToLocation()"
       style="width: 75%; padding: 8px; border-radius: 4px; border: 1px solid #38bdf8; background: #0f172a; color: white; font-size: 12px;">
    <button onclick="goToLocation()" 
            style="width: 20%; padding: 8px; background: #38bdf8; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">GÄ°T</button>
</div>
        <button class="btn reset-btn" onclick="location.reload()">RESET SYSTEM</button>
    </div>
    <div id="cesiumContainer"></div>

    <script>
        Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiIzMzEyYzc1OS03OTY0LTQ5MGYtODcwMi0zMGNiYmZjNGIxMTkiLCJpZCI6Mzc2MTk2LCJpYXQiOjE3Njc4NjA4NjJ9.aZRZorILCG4gIlzwCnm1L2SCp58z-TCg6yNaDbPLxnU';
        const GOOGLE_API_KEY = 'AIzaSyDDPGFsMFFW8Q8s9Y-2aonzk6LofSBuhps';

        const viewer = new Cesium.Viewer('cesiumContainer', {
            terrain: Cesium.Terrain.fromWorldTerrain(),
            animation: false, timeline: false, baseLayerPicker: false
        });

        viewer.scene.globe.depthTestAgainstTerrain = false;
        viewer.scene.camera.frustum.near = 0.1;

        let drone, waypoints = [], isLocked = false, isFlying = false, heading = 0;
        let dronePos = Cesium.Cartesian3.fromDegrees(28.9784, 41.0082, 100);
        let initialHomePos;

        // 1. Helikopter Model GÃ¼ncellemesi (init fonksiyonu iÃ§inde)
async function init() {
    try {
        const tileset = await Cesium.createGooglePhotorealistic3DTileset(GOOGLE_API_KEY);
        viewer.scene.primitives.add(tileset);
    } catch (e) { console.error("Tileset error:", e); }

    // Helikopterimizi ekliyoruz (GÃ¶rÃ¼nÃ¼rlÃ¼k iÃ§in Ã¶lÃ§eÄŸi artÄ±rÄ±ldÄ±)
drone = viewer.entities.add({
    name: "Helicopter",
    position: new Cesium.CallbackProperty(() => dronePos, false),
orientation: new Cesium.CallbackProperty(() => {
    // -90 derece kalibrasyonu burnu tam ileriye (W yÃ¶nÃ¼ne) sabitler
    return Cesium.Transforms.headingPitchRollQuaternion(
        dronePos, 
        new Cesium.HeadingPitchRoll(Cesium.Math.toRadians(heading - 90), 0, 0)
    );
}, false),
    model: { 
        uri: 'https://raw.githubusercontent.com/CesiumGS/cesium/main/Apps/SampleData/models/CesiumAir/Cesium_Air.glb', 
        minimumPixelSize: 100,
        scale: 1.5,
        disableDepthTestDistance: Number.POSITIVE_INFINITY 
    }
});

    viewer.camera.flyTo({ destination: Cesium.Cartesian3.fromDegrees(28.9784, 41.0082, 1000) });

    // 2. TÄ±klama ile Rota ve Heliport Belirleme
    const handler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);
    handler.setInputAction((click) => {
        if (isLocked || isFlying) return;
        
        const picked = viewer.scene.pickPosition(click.position);
        if (Cesium.defined(picked)) {
            const carto = Cesium.Cartographic.fromCartesian(picked);
            const droneAlt = Cesium.Cartographic.fromCartesian(dronePos).height;
            
            const fixedPos = Cesium.Cartesian3.fromDegrees(
                Cesium.Math.toDegrees(carto.longitude), 
                Cesium.Math.toDegrees(carto.latitude), 
                droneAlt
            );

            if (waypoints.length === 0) initialHomePos = dronePos;

            // Nokta tipini belirle (KalkÄ±ÅŸ, Yol, Ä°niÅŸ)
            let pointColor = Cesium.Color.YELLOW;
            let labelText = "WAYPOINT";
            if (waypoints.length === 0) { pointColor = Cesium.Color.DEEPSKYBLUE; labelText = "START HELIPORT"; }

            const wp = {
                pos: fixedPos,
                entity: viewer.entities.add({
                    position: new Cesium.CallbackProperty(() => wp.pos, false),
                    point: { pixelSize: 12, color: pointColor, outlineColor: Cesium.Color.WHITE, outlineWidth: 2, disableDepthTestDistance: Number.POSITIVE_INFINITY },
                    label: { text: labelText, font: '12px sans-serif', verticalOrigin: Cesium.VerticalOrigin.BOTTOM, pixelOffset: new Cesium.Cartesian2(0, -15), disableDepthTestDistance: Number.POSITIVE_INFINITY }
                }),
                anchor: viewer.entities.add({
                    polyline: {
                        positions: new Cesium.CallbackProperty(() => {
                            const c = Cesium.Cartographic.fromCartesian(wp.pos);
                            const terrainHeight = viewer.scene.sampleHeight(c) || 0;
                            return [Cesium.Cartesian3.fromRadians(c.longitude, c.latitude, terrainHeight), wp.pos];
                        }, false),
                        width: 1,
                        material: new Cesium.PolylineDashMaterialProperty({ color: Cesium.Color.WHITE.withAlpha(0.5) }),
                        disableDepthTestDistance: Number.POSITIVE_INFINITY 
                    }
                }),
                line: viewer.entities.add({
                    polyline: {
                        positions: new Cesium.CallbackProperty(() => {
                            let idx = waypoints.indexOf(wp);
                            let start = (idx === 0) ? initialHomePos : waypoints[idx-1].pos;
                            return [start, wp.pos];
                        }, false),
                        width: 8,
                        material: Cesium.Color.fromCssColorString('#0ea5e9').withAlpha(0.6), // HavacÄ±lÄ±k koridoru mavisi
                        disableDepthTestDistance: Number.POSITIVE_INFINITY,
                        arcType: Cesium.ArcType.NONE
                    }
                })
            };
            waypoints.push(wp);
            
            // Son noktayÄ± her zaman "DESTINATION HELIPORT" olarak gÃ¼ncelle
            if (waypoints.length > 1) {
                waypoints[waypoints.length-1].entity.label.text = "DESTINATION HELIPORT";
                waypoints[waypoints.length-1].entity.point.color = Cesium.Color.RED;
                if (waypoints.length > 2) {
                    waypoints[waypoints.length-2].entity.label.text = "CORRIDOR POINT";
                    waypoints[waypoints.length-2].entity.point.color = Cesium.Color.YELLOW;
                }
            }
        }
    }, Cesium.ScreenSpaceEventType.LEFT_CLICK);
}

document.addEventListener('keydown', (e) => {
    if (isLocked || isFlying) return;
    const k = e.key.toLowerCase();
    
    // Mevcut konumu al
    const c = Cesium.Cartographic.fromCartesian(dronePos);
    let lon = Cesium.Math.toDegrees(c.longitude);
    let lat = Cesium.Math.toDegrees(c.latitude);
    let alt = c.height;
    
    // Helikopter hÄ±zÄ± (HavacÄ±lÄ±k iÃ§in biraz daha artÄ±rÄ±ldÄ±)
    const moveStep = 0.0001; 

    // YÃ¶n Hesaplama (W artÄ±k baktÄ±ÄŸÄ±n yÃ¶ne gider)
    // Helikopterin heading aÃ§Ä±sÄ±nÄ± radyana Ã§evirip trigonometrik ilerleme yapÄ±yoruz
    const rad = Cesium.Math.toRadians(heading);
// W ve S tuÅŸlarÄ±nÄ±n yÃ¶nÃ¼nÃ¼ 180 derece Ã§evirdik (Ä°leri gitmesi iÃ§in)
if (k === 'w') { 
    lat += moveStep * Math.cos(rad); 
    lon += moveStep * Math.sin(rad); 
}
if (k === 's') { 
    lat -= moveStep * Math.cos(rad); 
    lon -= moveStep * Math.sin(rad); 
}
// A ve D tuÅŸlarÄ± dÃ¶nÃ¼ÅŸ yÃ¶nÃ¼nÃ¼ daha doÄŸal hissettirmek iÃ§in hassaslaÅŸtÄ±rÄ±ldÄ±
if (k === 'a') heading -= 2; 
if (k === 'd') heading += 2;
    
    // YÃ¼kseklik (Q/E)
    if (k === 'q') alt += 1;
    if (k === 'e') alt -= 1;

    // Pozisyonu GÃ¼ncelle
    dronePos = Cesium.Cartesian3.fromDegrees(lon, lat, alt);

    // AGL HESAPLAMA (KRÄ°TÄ°K DÃœZELTME)
    // sampleHeight helikopterin kendisine Ã§arpmasÄ±n diye drone objesini hariÃ§ tutuyoruz
    const groundHeight = viewer.scene.sampleHeight(c, [drone]) || 0;
    const currentAGL = alt - groundHeight;

    // Dashboard GÃ¼ncelleme
    document.getElementById('agl-txt').innerText = "AGL: " + Math.round(currentAGL) + " m (Yerden)";
    document.getElementById('msl-txt').innerText = "MSL: " + Math.round(alt) + " m (Denizden)";
});

        function toggleLock() {
            if (waypoints.length === 0) return;
            isLocked = !isLocked;
            document.getElementById('start-btn').style.display = isLocked ? "block" : "none";
            document.getElementById('lock-btn').innerText = isLocked ? "ðŸ”“ UNLOCK" : "ðŸ”’ LOCK MISSION";
        }

        async function startFlight() {
            isFlying = true;
            viewer.trackedEntity = drone;
            let currentPos = dronePos;
            for (const wp of waypoints) {
                const start = currentPos;
                const end = wp.pos;
                const duration = Cesium.Cartesian3.distance(start, end) / 20;
                await new Promise(resolve => {
                    let startTime = performance.now();
function frame(now) {
    let t = Math.min((now - startTime) / (duration * 1000), 1);
    
    // Mevcut konum ve sonraki konum arasÄ±ndaki aÃ§Ä±yÄ± hesapla
    const nextPos = end;
    const direction = Cesium.Cartesian3.subtract(nextPos, dronePos, new Cesium.Cartesian3());
    if (!Cesium.Cartesian3.equalsEpsilon(direction, Cesium.Cartesian3.ZERO, Cesium.Math.EPSILON6)) {
        // Helikopterin burnunu otomatik olarak uÃ§uÅŸ yÃ¶nÃ¼ne Ã§evir
        const lookAt = Cesium.Transforms.headingPitchRollQuaternion(dronePos, 
            new Cesium.HeadingPitchRoll(Math.atan2(direction.y, direction.x), 0, 0));
        // Buradaki "heading" deÄŸiÅŸkenini gÃ¼ncelliyoruz ki model doÄŸru baksÄ±n
        heading = Cesium.Math.toDegrees(Math.atan2(direction.y, direction.x));
    }

    dronePos = Cesium.Cartesian3.lerp(start, end, t, new Cesium.Cartesian3());
    if (t < 1) requestAnimationFrame(frame); else resolve();
}
                    requestAnimationFrame(frame);
                });
                currentPos = end;
            }
            isFlying = false;
            viewer.trackedEntity = undefined;
        }







        async function goToLocation() {
    const query = document.getElementById('search-city').value.trim();
    if (!query) return;

    // 1. Senaryo: Koordinat giriÅŸi (Ã–rn: 40.1, 29.5)
    if (query.includes(',')) {
        const coords = query.split(',');
        const lat = parseFloat(coords[0]);
        const lon = parseFloat(coords[1]);
        if (!isNaN(lat) && !isNaN(lon)) {
            teleportHelicopter(lat, lon);
            return;
        }
    }

    // 2. Senaryo: Yer ismi giriÅŸi (Ã–rn: "Bursa", "AnÄ±tkabir")
    try {
        const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`);
        const data = await response.json();

        if (data && data.length > 0) {
            const lat = parseFloat(data[0].lat);
            const lon = parseFloat(data[0].lon);
            teleportHelicopter(lat, lon);
        } else {
            alert("Yer bulunamadÄ±. LÃ¼tfen daha spesifik bir isim yazÄ±n.");
        }
    } catch (error) {
        console.error("Arama hatasÄ±:", error);
        alert("Arama servisine ÅŸu an ulaÅŸÄ±lamÄ±yor.");
    }
}

// Helikopteri ve kamerayÄ± taÅŸÄ±yan yardÄ±mcÄ± fonksiyon
function teleportHelicopter(lat, lon) {
    // Helikopteri oraya taÅŸÄ±
    dronePos = Cesium.Cartesian3.fromDegrees(lon, lat, 100);
    
    // KamerayÄ± oraya uÃ§ur
    viewer.camera.flyTo({
        destination: Cesium.Cartesian3.fromDegrees(lon, lat, 1000),
        duration: 2
    });
}





        



        
        
                init();
    </script>
</body>
</html>









