<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>NaviVortex V16.11</title>
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.114/Build/Cesium/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.114/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    <style>
        body, html, #cesiumContainer { width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden; background-color: #000; }
        #dashboard {
            position: absolute; top: 20px; left: 20px; width: 260px; 
            background: rgba(15, 23, 42, 0.9); z-index: 100; padding: 20px;
            border-radius: 12px; font-family: sans-serif; color: white; border: 1px solid #38bdf8;
        }
        .btn { width: 100%; padding: 12px; margin-top: 10px; border-radius: 6px; border: none; cursor: pointer; font-weight: bold; text-transform: uppercase; }
        #start-btn { background: #10b981; color: white; display: none; }
        #lock-btn { background: #0ea5e9; color: white; }
        .reset-btn { background: #ef4444; color: white; margin-top: 20px; font-size: 10px; }
    </style>
</head>
<body>
    <div id="dashboard">
        <h2 style="margin:0 0 10px 0; color:#38bdf8;">NAVIVORTEX V54</h2>
        <div id="agl-txt" style="color: #10b981;">AGL: 100 m (Yerden)</div>
        <div id="msl-txt" style="color: #38bdf8; font-size: 0.8em;">MSL: 100 m (Denizden)</div>
        <button id="lock-btn" class="btn" onclick="toggleLock()">ðŸ”’ LOCK MISSION</button>
        <button id="start-btn" class="btn" onclick="startFlight()">ðŸš€ START FLIGHT</button>
        <button class="btn reset-btn" onclick="location.reload()">RESET SYSTEM</button>
    </div>
    <div id="cesiumContainer"></div>

    <script>
        Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiIzMzEyYzc1OS03OTY0LTQ5MGYtODcwMi0zMGNiYmZjNGIxMTkiLCJpZCI6Mzc2MTk2LCJpYXQiOjE3Njc4NjA4NjJ9.aZRZorILCG4gIlzwCnm1L2SCp58z-TCg6yNaDbPLxnU';
        const GOOGLE_API_KEY = 'AIzaSyDDPGFsMFFW8Q8s9Y-2aonzk6LofSBuhps';

        const viewer = new Cesium.Viewer('cesiumContainer', {
            terrain: Cesium.Terrain.fromWorldTerrain(),
            animation: false, timeline: false, baseLayerPicker: false
        });

        viewer.scene.globe.depthTestAgainstTerrain = false;
        viewer.scene.camera.frustum.near = 0.1;

        let drone, waypoints = [], isLocked = false, isFlying = false, heading = 0;
        let dronePos = Cesium.Cartesian3.fromDegrees(28.9784, 41.0082, 100);
        let initialHomePos;

        async function init() {
            try {
                const tileset = await Cesium.createGooglePhotorealistic3DTileset(GOOGLE_API_KEY);
                viewer.scene.primitives.add(tileset);
            } catch (e) { console.error("Tileset error:", e); }

            drone = viewer.entities.add({
                position: new Cesium.CallbackProperty(() => dronePos, false),
                orientation: new Cesium.CallbackProperty(() => {
                    return Cesium.Transforms.headingPitchRollQuaternion(dronePos, new Cesium.HeadingPitchRoll(Cesium.Math.toRadians(heading), 0, 0));
                }, false),
                model: { 
                    uri: 'https://raw.githubusercontent.com/CesiumGS/cesium/main/Apps/SampleData/models/CesiumDrone/CesiumDrone.glb', 
                    minimumPixelSize: 80,
                    disableDepthTestDistance: Number.POSITIVE_INFINITY 
                }
            });

            viewer.camera.flyTo({ destination: Cesium.Cartesian3.fromDegrees(28.9784, 41.0082, 400) });

            const handler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);
handler.setInputAction((click) => {
    if (isLocked || isFlying) return;
    
    const picked = viewer.scene.pickPosition(click.position);
    if (Cesium.defined(picked)) {
        const carto = Cesium.Cartographic.fromCartesian(picked);
        
        // 1. Drone'un o anki MUTLAK (deniz seviyesi) yÃ¼ksekliÄŸini alÄ±yoruz
        const droneAlt = Cesium.Cartographic.fromCartesian(dronePos).height;
        
        // 2. NoktayÄ± tam olarak drone'un uÃ§tuÄŸu bu mutlak yÃ¼ksekliÄŸe koyuyoruz
        // (BÃ¶ylece arazi deÄŸiÅŸse bile rota dÃ¼mdÃ¼z devam eder)
        const fixedPos = Cesium.Cartesian3.fromDegrees(
            Cesium.Math.toDegrees(carto.longitude), 
            Cesium.Math.toDegrees(carto.latitude), 
            droneAlt
        );

        if (waypoints.length === 0) initialHomePos = dronePos;

        const wp = {
            pos: fixedPos,
            entity: viewer.entities.add({
                position: new Cesium.CallbackProperty(() => wp.pos, false),
                point: { 
                    pixelSize: 10, 
                    color: Cesium.Color.YELLOW, 
                    disableDepthTestDistance: Number.POSITIVE_INFINITY 
                }
            }),
            // Ä°zdÃ¼ÅŸÃ¼m HattÄ±: Tam o noktadaki zemini Ã¶lÃ§Ã¼p oraya kadar iner
            anchor: viewer.entities.add({
                polyline: {
                    positions: new Cesium.CallbackProperty(() => {
                        const c = Cesium.Cartographic.fromCartesian(wp.pos);
                        const terrainHeight = viewer.scene.sampleHeight(c) || 0;
                        const groundPos = Cesium.Cartesian3.fromRadians(c.longitude, c.latitude, terrainHeight);
                        return [groundPos, wp.pos];
                    }, false),
                    width: 2,
                    material: new Cesium.PolylineDashMaterialProperty({
                        color: Cesium.Color.WHITE.withAlpha(0.7),
                        dashLength: 8
                    }),
                    disableDepthTestDistance: Number.POSITIVE_INFINITY 
                }
            }),
            // YeÅŸil Rota HattÄ±
            line: viewer.entities.add({
                polyline: {
                    positions: new Cesium.CallbackProperty(() => {
                        let idx = waypoints.indexOf(wp);
                        let start = (idx === 0) ? initialHomePos : waypoints[idx-1].pos;
                        return [start, wp.pos];
                    }, false),
                    width: 6,
                    material: Cesium.Color.GREEN,
                    depthFailMaterial: Cesium.Color.GREEN,
                    disableDepthTestDistance: Number.POSITIVE_INFINITY,
                    arcType: Cesium.ArcType.NONE
                }
            })
        };
        waypoints.push(wp);
    }
}, Cesium.ScreenSpaceEventType.LEFT_CLICK);
        }

document.addEventListener('keydown', (e) => {
    if (isLocked || isFlying) return;
    
    const k = e.key.toLowerCase();
    const c = Cesium.Cartographic.fromCartesian(dronePos);
    let lon = Cesium.Math.toDegrees(c.longitude);
    let lat = Cesium.Math.toDegrees(c.latitude);
    let currentMSL = c.height; // Mevcut deniz seviyesi yÃ¼ksekliÄŸi
    
    const moveStep = 0.00005; // WASD hÄ±zÄ±

    // YÃ¶n Kontrolleri (WASD)
    if (k === 'w') { lat += moveStep * Math.cos(Cesium.Math.toRadians(heading)); lon += moveStep * Math.sin(Cesium.Math.toRadians(heading)); }
    if (k === 's') { lat -= moveStep * Math.cos(Cesium.Math.toRadians(heading)); lon -= moveStep * Math.sin(Cesium.Math.toRadians(heading)); }
    if (k === 'a') heading -= 5;
    if (k === 'd') heading += 5;
    
    // YÃ¼kseklik Kontrolleri (Q/E) - TAM 1 METRE HASSASÄ°YET
    if (k === 'q') currentMSL += 1;
    if (k === 'e') currentMSL -= 1;

    // "Geri Al" (Z TuÅŸu)
    if (k === 'z' && waypoints.length > 0) {
        const lastWP = waypoints.pop();
        viewer.entities.remove(lastWP.entity);
        viewer.entities.remove(lastWP.anchor);
        viewer.entities.remove(lastWP.line);
        return;
    }

    // Yeni pozisyonu mutlak olarak gÃ¼ncelle
    dronePos = Cesium.Cartesian3.fromDegrees(lon, lat, currentMSL);
    
    // Bilgileri ekrana yaz
    const groundHeight = viewer.scene.sampleHeight(c) || 0;
    const aglValue = currentMSL - groundHeight;
    
    document.getElementById('agl-txt').innerText = "AGL: " + Math.round(aglValue) + " m (Yerden)";
    document.getElementById('msl-txt').innerText = "MSL: " + Math.round(currentMSL) + " m (Denizden)";
});

        function toggleLock() {
            if (waypoints.length === 0) return;
            isLocked = !isLocked;
            document.getElementById('start-btn').style.display = isLocked ? "block" : "none";
            document.getElementById('lock-btn').innerText = isLocked ? "ðŸ”“ UNLOCK" : "ðŸ”’ LOCK MISSION";
        }

        async function startFlight() {
            isFlying = true;
            viewer.trackedEntity = drone;
            let currentPos = dronePos;
            for (const wp of waypoints) {
                const start = currentPos;
                const end = wp.pos;
                const duration = Cesium.Cartesian3.distance(start, end) / 20;
                await new Promise(resolve => {
                    let startTime = performance.now();
                    function frame(now) {
                        let t = Math.min((now - startTime) / (duration * 1000), 1);
                        dronePos = Cesium.Cartesian3.lerp(start, end, t, new Cesium.Cartesian3());
                        if (t < 1) requestAnimationFrame(frame); else resolve();
                    }
                    requestAnimationFrame(frame);
                });
                currentPos = end;
            }
            isFlying = false;
            viewer.trackedEntity = undefined;
        }

                init();
    </script>
</body>
</html>



