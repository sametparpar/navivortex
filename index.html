<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>NaviVortex 16.55</title>
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.114/Build/Cesium/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.114/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    <style>
        body, html, #cesiumContainer { width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden; background-color: #020617; }
        
        /* SOL PANEL: PARAMETRELER */
        #params-panel {
            position: absolute; top: 20px; left: 20px; width: 280px;
            background: rgba(15, 23, 42, 0.95); padding: 20px; border-radius: 12px;
            border: 1px solid #38bdf8; color: white; font-family: sans-serif; z-index: 100;
        }

        /* SAĞ PANEL: KOORDİNAT TABLOSU */
        #data-table {
            position: absolute; top: 20px; right: 20px; width: 320px;
            background: rgba(15, 23, 42, 0.95); padding: 15px; border-radius: 12px;
            border: 1px solid #10b981; color: white; font-family: monospace; z-index: 100;
            max-height: 80vh; overflow-y: auto;
        }

        .input-group { margin-bottom: 15px; }
        label { display: block; font-size: 11px; color: #94a3b8; margin-bottom: 5px; text-transform: uppercase; }
        input, select { width: 100%; padding: 8px; background: #1e293b; border: 1px solid #334155; color: #38bdf8; border-radius: 4px; }
        
        .btn-export { background: #0ea5e9; color: white; border: none; padding: 10px; width: 100%; 
                      border-radius: 6px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn-export:hover { background: #0284c7; }
        
        .waypoint-item { border-bottom: 1px solid #334155; padding: 8px 0; font-size: 12px; }
        .energy-warn { color: #ef4444; font-weight: bold; font-size: 12px; margin-top: 10px; display:none; }
    </style>
</head>
<body>

<div id="params-panel">
    <h2 style="color:#38bdf8; margin-top:0;">NAVIVORTEX V60</h2>
    
    <div class="input-group">
        <label>Drone Weight (kg)</label>
        <input type="number" id="uav-weight" value="1.5" step="0.1" onchange="calculateLogistics()">
    </div>
    
    <div class="input-group">
        <label>Battery Capacity (mAh)</label>
        <input type="number" id="uav-bat" value="5000" onchange="calculateLogistics()">
    </div>

<div class="input-group">
        <label>Cruise Speed (m/s)</label>
        <input type="number" id="uav-speed" value="15" onchange="calculateLogistics()">
    </div>

    <div class="input-group">
        <label>Wind Speed (m/s) - Headwind</label>
        <input type="number" id="uav-wind" value="0" onchange="calculateLogistics()">
    </div>

    <hr style="border:0; border-top:1px solid #334155;">
    
    
    <label>Universal Export</label>
    <button class="btn-export" onclick="exportMission('LITCHI')">EXPORT LITCHI (.CSV)</button>
    <button class="btn-export" onclick="exportMission('DJI')">EXPORT DJI PILOT (.KMZ)</button>
    <button class="btn-export" onclick="exportMission('ARDU')">EXPORT ARDUPILOT (.WAYPOINT)</button>
    
    <hr style="border:0; border-top:1px solid #334155; margin: 15px 0;">
    <label>Mission Tools</label>
    <button class="btn-export" style="background: #10b981;" onclick="generateSearchGrid()">GENERATE SEARCH GRID</button>
    
    <div id="energy-alert" class="energy-warn">⚠️ INSUFFICIENT ENERGY!</div>
</div>

<div id="data-table">
    <div style="font-weight:bold; border-bottom:1px solid #10b981; padding-bottom:5px; margin-bottom:10px;">MISSION LOGBOOK</div>
    <div id="wp-list">
        <div style="color:#94a3b8; font-style:italic;">Click map to add waypoints...</div>
    </div>
    <div id="total-stats" style="margin-top:15px; padding-top:10px; border-top:1px dashed #334155;">
        Dist: 0.00 km | Time: 0.0 min
    </div>
</div>

<div id="cesiumContainer"></div>

<script>
Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiIzMzEyYzc1OS03OTY0LTQ5MGYtODcwMi0zMGNiYmZjNGIxMTkiLCJpZCI6Mzc2MTk2LCJpYXQiOjE3Njc4NjA4NjJ9.aZRZorILCG4gIlzwCnm1L2SCp58z-TCg6yNaDbPLxnU'; // Buraya kendi token'ını koy

const viewer = new Cesium.Viewer('cesiumContainer', {
    terrain: Cesium.Terrain.fromWorldTerrain(),
    animation: false, timeline: false, baseLayerPicker: false, infoBox: false
});

let waypoints = [];
let routeLine = null;

// TIKLAMA İLE NOKTA EKLEME
const handler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);
handler.setInputAction((click) => {
    const picked = viewer.scene.pickPosition(click.position);
    if (Cesium.defined(picked)) {
        addWaypoint(picked);
    }
}, Cesium.ScreenSpaceEventType.LEFT_CLICK);

function addWaypoint(pos) {
    const carto = Cesium.Cartographic.fromCartesian(pos);
    const wp = {
        lat: Cesium.Math.toDegrees(carto.latitude),
        lon: Cesium.Math.toDegrees(carto.longitude),
        alt: Math.round(carto.height + 50), // Varsayılan 50m AGL
        cartesian: pos
    };
    
    waypoints.push(wp);
    renderVisuals();
    updateUI();
    calculateLogistics();
}

function renderVisuals(failIndex) {
    if (routeLine) viewer.entities.remove(routeLine);
    if (window.failLine) viewer.entities.remove(window.failLine);

    const positions = waypoints.map(w => w.cartesian);
    
    if (positions.length > 1) {
        // Güvenli Rota (Mavi)
        const safePath = failIndex === -1 ? positions : positions.slice(0, failIndex + 1);
        routeLine = viewer.entities.add({
            polyline: {
                positions: safePath,
                width: 4,
                material: Cesium.Color.fromCssColorString('#38bdf8'),
                disableDepthTestDistance: Number.POSITIVE_INFINITY
            }
        });

        // Tehlikeli Rota (Kırmızı)
        if (failIndex !== -1) {
            const dangerPath = positions.slice(failIndex);
            window.failLine = viewer.entities.add({
                polyline: {
                    positions: dangerPath,
                    width: 4,
                    material: Cesium.Color.RED,
                    dashLength: 16,
                    disableDepthTestDistance: Number.POSITIVE_INFINITY
                }
            });
        }
    }
}








    

function updateUI() {
    const list = document.getElementById('wp-list');
    list.innerHTML = "";
    let totalDist = 0;

    waypoints.forEach((wp, i) => {
        if (i > 0) {
            const p1 = Cesium.Cartesian3.fromDegrees(waypoints[i-1].lon, waypoints[i-1].lat, waypoints[i-1].alt);
            const p2 = Cesium.Cartesian3.fromDegrees(wp.lon, wp.lat, wp.alt);
            totalDist += Cesium.Cartesian3.distance(p1, p2);
        }

        list.innerHTML += `
            <div class="waypoint-item">
                <b>#${i+1}</b> - LAT: ${wp.lat.toFixed(5)}<br>
                LON: ${wp.lon.toFixed(5)} | ALT: ${wp.alt}m
            </div>
        `;
    });

    const speed = parseFloat(document.getElementById('uav-speed').value);
    const time = (totalDist / speed) / 60;
    document.getElementById('total-stats').innerText = `Dist: ${(totalDist/1000).toFixed(2)} km | Time: ${time.toFixed(1)} min`;
}

function calculateLogistics() {
    if (waypoints.length < 2) return;

    const weight = parseFloat(document.getElementById('uav-weight').value);
    const capacity = parseFloat(document.getElementById('uav-bat').value);
    const speed = parseFloat(document.getElementById('uav-speed').value);
    const wind = parseFloat(document.getElementById('uav-wind').value);
    
    let currentEnergy = capacity;
    let failPointIndex = -1;
    let totalDist = 0;

    // Basit Fizik Formülü: Tüketim = (Ağırlık * Mesafe) + (Zaman * (Hız + Rüzgar Direnci))
    for (let i = 1; i < waypoints.length; i++) {
        const p1 = waypoints[i-1].cartesian;
        const p2 = waypoints[i].cartesian;
        const dist = Cesium.Cartesian3.distance(p1, p2);
        
        // Rüzgara karşı uçuşta efektif hız düşer, tüketim artar
        const effectiveSpeed = speed - wind;
        const timeNeeded = dist / (effectiveSpeed > 0 ? effectiveSpeed : 0.1);
        
        // Sektör bazlı tüketim (mAh cinsinden basitleştirilmiş hesap)
        const consumption = (weight * dist * 0.1) + (timeNeeded * 5);
        currentEnergy -= consumption;

        if (currentEnergy <= 0 && failPointIndex === -1) {
            failPointIndex = i; // Enerjinin bittiği nokta
        }
    }

    const alertBox = document.getElementById('energy-alert');
    if (failPointIndex !== -1) {
        alertBox.style.display = "block";
        alertBox.innerText = "⚠️ BATTERY WILL FAIL AT WAYPOINT #" + (failPointIndex + 1);
        renderVisuals(failPointIndex);
    } else {
        alertBox.style.display = "none";
        renderVisuals(-1);
    }
}








    
function exportMission(type) {
    if (waypoints.length === 0) {
        alert("No mission data to export! Please add waypoints first.");
        return;
    }

    let csvContent = "latitude,longitude,altitude(m),heading(deg),curvesize(m),rotationdir,poi_latitude,poi_longitude,poi_altitude(m),poi_headingmode\n";
    
    waypoints.forEach(wp => {
        // Litchi CSV Format: lat, lon, alt, heading, curvesize, rotation, poi_lat, poi_lon, poi_alt, poi_mode
        csvContent += `${wp.lat},${wp.lon},${wp.alt},0,0,0,0,0,0,0\n`;
    });

    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    
    link.setAttribute("href", url);
    link.setAttribute("download", `NaviVortex_Mission_${type}.csv`);
    link.style.visibility = 'hidden';
    
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    console.log("Mission exported as " + type);
}



    

// --- NEW LOGIC START ---
function generateSearchGrid() {
    if (waypoints.length === 0) {
        alert("Please click on the map first to set a starting point for the search!");
        return;
    }

    const startWp = waypoints[0];
    const spacing = 0.0015; // Distance between grid lines (approx 150m)
    
    // Generate a 4-point snake (S) pattern automatically
    const gridPoints = [
        { lat: startWp.lat, lon: startWp.lon + spacing, alt: startWp.alt },
        { lat: startWp.lat + spacing, lon: startWp.lon + spacing, alt: startWp.alt },
        { lat: startWp.lat + spacing, lon: startWp.lon, alt: startWp.alt },
        { lat: startWp.lat + (spacing * 2), lon: startWp.lon, alt: startWp.alt }
    ];

    gridPoints.forEach(p => {
        // Convert lat/lon back to Cesium Cartesian for rendering
        p.cartesian = Cesium.Cartesian3.fromDegrees(p.lon, p.lat, p.alt);
        waypoints.push(p);
    });

    renderVisuals();
    updateUI();
    calculateLogistics();
    console.log("Search Grid Generated successfully.");
}
// --- NEW LOGIC END ---
</script>
</body>
</html>





