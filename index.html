<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>NaviVortex V19 - Precision Mission</title>
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.114/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.114/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
  <style>
    body, html, #cesiumContainer { width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden; background-color: #0b0f19; }
    #dashboard {
        position: absolute; top: 0; left: 0; width: 300px; height: 100%;
        background: rgba(15, 23, 42, 0.95); z-index: 100; padding: 20px;
        border-right: 1px solid #0ea5e9; font-family: 'Inter', sans-serif; color: white;
    }
    .telemetry-card { background: #1e293b; padding: 12px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #38bdf8; }
    .label { font-size: 10px; color: #94a3b8; text-transform: uppercase; }
    .value { font-size: 18px; font-weight: bold; color: #f1f5f9; }
    #danger-alert { background: #7f1d1d; color: #fecaca; padding: 10px; border-radius: 6px; display: none; font-weight: bold; text-align: center; }
  </style>
</head>
<body>
  <div id="dashboard">
    <h2 style="color:#38bdf8; margin:0;">NAVIVORTEX</h2>
    <p style="font-size:10px; color:#64748b;">FLIGHT TELEMETRY SYSTEM</p>
    
    <div id="danger-alert">⚠️ COLLISION DETECTED</div>

    <div class="telemetry-card">
        <div class="label">Current Altitude (AMSL)</div>
        <div id="alt-val" class="value">100 m</div>
    </div>

    <div class="telemetry-card">
        <div class="label">Planned Path Distance</div>
        <div id="dist-val" class="value">0 m</div>
    </div>

    <div class="telemetry-card">
        <div class="label">Safety Status</div>
        <div id="status-val" class="value" style="color:#22c55e;">CLEAR</div>
    </div>

    <button onclick="location.reload()" style="width:100%; padding:10px; background:#334155; color:white; border:none; border-radius:6px; cursor:pointer;">RESET MISSION</button>
  </div>

  <div id="cesiumContainer"></div>

  <script>
    Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiIzMzEyYzc1OS03OTY0LTQ5MGYtODcwMi0zMGNiYmZjNGIxMTkiLCJpZCI6Mzc2MTk2LCJpYXQiOjE3Njc4NjA4NjJ9.aZRZorILCG4gIlzwCnm1L2SCp58z-TCg6yNaDbPLxnU';
    const GOOGLE_API_KEY = 'AIzaSyDDPGFsMFFW8Q8s9Y-2aonzk6LofSBuhps';

    const viewer = new Cesium.Viewer('cesiumContainer', {
      terrain: Cesium.Terrain.fromWorldTerrain(),
      animation: false, timeline: false, baseLayerPicker: false
    });

    let droneEntity, waypoints = [];

    async function init() {
      const tileset = await Cesium.createGooglePhotorealistic3DTileset(GOOGLE_API_KEY);
      viewer.scene.primitives.add(tileset);
      
      const startPos = Cesium.Cartesian3.fromDegrees(28.9784, 41.0082, 100);
      droneEntity = viewer.entities.add({
          position: startPos,
          model: { uri: 'https://raw.githubusercontent.com/CesiumGS/cesium/main/Apps/SampleData/models/CesiumDrone/CesiumDrone.glb', minimumPixelSize: 128 }
      });
      viewer.trackedEntity = droneEntity;

      const handler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);
      handler.setInputAction((click) => {
          // Binaları algılamak için daha güçlü 'pick' metodu
          const pos = viewer.scene.pickPosition(click.position);
          if (Cesium.defined(pos)) {
              waypoints.push(pos);
              viewer.entities.add({ 
                position: pos, 
                point: { pixelSize: 10, color: Cesium.Color.YELLOW, disableDepthTestDistance: Number.MAX_VALUE } 
              });

              if (waypoints.length > 1) {
                  const start = waypoints[waypoints.length-2];
                  const end = waypoints[waypoints.length-1];
                  
                  // Çarpışma Analizi (Raycast)
                  const direction = Cesium.Cartesian3.normalize(Cesium.Cartesian3.subtract(end, start, new Cesium.Cartesian3()), new Cesium.Cartesian3());
                  const ray = new Cesium.Ray(start, direction);
                  const obstacle = viewer.scene.pickFromRay(ray);
                  const dist = Cesium.Cartesian3.distance(start, end);
                  
                  const isBlocked = Cesium.defined(obstacle) && Cesium.Cartesian3.distance(start, obstacle.position) < dist;

                  viewer.entities.add({
                      polyline: {
                          positions: [start, end],
                          width: 4,
                          material: isBlocked ? Cesium.Color.RED : Cesium.Color.GREEN,
                          disableDepthTestDistance: Number.MAX_VALUE
                      }
                  });
                  
                  if(isBlocked) {
                      document.getElementById('danger-alert').style.display = 'block';
                      document.getElementById('status-val').innerText = "BLOCKED";
                      document.getElementById('status-val').style.color = "#ef4444";
                  }
              }
          }
      }, Cesium.ScreenSpaceEventType.LEFT_CLICK);

      // Telemetri Güncelleme (Altitude)
      viewer.clock.onTick.addEventListener(() => {
          const p = droneEntity.position.getValue(viewer.clock.currentTime);
          const c = Cesium.Ellipsoid.WGS84.cartesianToCartographic(p);
          document.getElementById('alt-val').innerText = Math.round(c.height) + " m";
      });
    }

    init();
  </script>
</body>
</html>
